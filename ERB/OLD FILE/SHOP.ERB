;--------------------------------------------------
@EVENTSHOP
#DIM CCOUNT
#DIM LCOUNT
REDRAW 0

;パーティメンバー管理
CALL SET_PARTYMEMBER

;襲撃イベント後のスキップ
;RAID_HANTEIで判定を通過してイベントが開始されると$RAID_SKIPまで飛び、途中のイベントをスキップする（ターンが余分に経過してしまうため）
;戦闘が終わるとSHOPに戻ってくるので、元の位置$AFTER_RAIDまで飛ばして処理完了。ここまで１セット
IF FLAG:45 > 0
	LOCAL = TARGET
	;救出されたキャラの治療
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		SIF CCOUNT >= CHARANUM
			BREAK

		IF CFLAG:CCOUNT:0 == -1
			TARGET = CCOUNT
			IF CFLAG:TARGET:6 == -1
				PRINTL 
				CALL RESCUE_CHILD,TARGET
				SIF RESULT < 0
					CCOUNT -= RESULT
			ELSE
				CALL AFTER_RESCUED,TARGET
			ENDIF
		ELSE
			CALL INMON_RECOVERY,CCOUNT
		ENDIF
	NEXT
	TARGET = LOCAL
	PRINTW 

	;襲撃フラグを折る
	FLAG:45 = 0
	GOTO AFTER_RAID
ENDIF


;全てのキャラが行動予定を終了しているか
;していない場合はSHOP_ACTIONに飛ばしてループを作っている
IF DAY == 0 || FLAG:799 > CHARANUM || FLAG:64 != 0
	SIF FLAG:64 == 0
		FLAG:799 = 0

	;ゲーム開始処理
	IF DAY == 0
		DAY = 1
		TIME = 0
		FLAG:60 = 10002
		FLAG:64 = 0
		FLAG:799 = 0
		TARGET = 1
		CALL LB
		PRINTL ゲームを開始します
		PRINTW 
		GOTO RAID_SKIP
	ELSE
		;前ターンで行動開始前に選択していたキャラにターゲットをあわせる
		;ターン中で使用不可になった場合は使用可能なキャラのうち一番若いキャラにあわせる
		IF CFLAG:(FLAG:798):0 != 0
			FOR CCOUNT, 0, CHARANUM
				SIF CCOUNT == MASTER
					CONTINUE
				
				IF CFLAG:CCOUNT:0 == 0
					TARGET = CCOUNT
					BREAK 
				ENDIF
			NEXT
		ELSE
			TARGET = FLAG:798
		ENDIF
	ENDIF
ELSE
	JUMP SHOP_ACTION
ENDIF

;エンディング判定
CALL ENDING
;強制的にタイトルに戻る場合
IF FLAG:999 == -999
	CLEARLINE LINECOUNT
	RESETDATA
	BEGIN TITLE
ELSEIF FLAG:64 != 0
	GOTO RAID_SKIP
ENDIF

PRINTL 
;救出されたキャラの治療と記録更新
FOR CCOUNT, 0, CHARANUM
	SIF CCOUNT == MASTER
		CONTINUE
	SIF CCOUNT >= CHARANUM
		BREAK

	;ステータスの再計算
	CALL LEVELSTATUS,CCOUNT

	IF CFLAG:CCOUNT:0 == -1
		TARGET = CCOUNT
		IF CFLAG:TARGET:6 == -1
			PRINTL 
			CALL RESCUE_CHILD,TARGET
			SIF RESULT < 0
				CCOUNT -= RESULT
		ELSE
			CALL AFTER_RESCUED,TARGET
		ENDIF
		PRINTW 
	ELSE
		CALL INMON_RECOVERY,CCOUNT
	ENDIF
	;娘を施設に預けた場合の処理
	SIF CCOUNT > CHARANUM - 1
		BREAK

	;記録保持
	IF MAXBASE:CCOUNT:体力 > GLOBAL:103
		GLOBAL:103 = MAXBASE:CCOUNT:体力
		GLOBALS:0 = %NAME:CCOUNT,40,LEFT%（Lv{ABL:CCOUNT:レベル}）　{GLOBAL:103}
	ENDIF
	IF MAXBASE:CCOUNT:気力 > GLOBAL:104
		GLOBAL:104 = MAXBASE:CCOUNT:気力
		GLOBALS:1 = %NAME:CCOUNT,40,LEFT%（Lv{ABL:CCOUNT:レベル}）　{GLOBAL:104}
	ENDIF
	IF MAXBASE:CCOUNT:性耐性 > GLOBAL:105
		GLOBAL:105 = MAXBASE:CCOUNT:性耐性
		GLOBALS:2 = %NAME:CCOUNT,40,LEFT%（Lv{ABL:CCOUNT:レベル}）　{GLOBAL:105}
	ENDIF
	IF MAXBASE:CCOUNT:攻撃 > GLOBAL:106
		GLOBAL:106 = MAXBASE:CCOUNT:攻撃
		GLOBALS:10 = %NAME:CCOUNT,40,LEFT%（Lv{ABL:CCOUNT:レベル}）　{GLOBAL:106}
	ENDIF
	IF MAXBASE:CCOUNT:防御 > GLOBAL:107
		GLOBAL:107 = MAXBASE:CCOUNT:防御
		GLOBALS:11 = %NAME:CCOUNT,40,LEFT%（Lv{ABL:CCOUNT:レベル}）　{GLOBAL:107}
	ENDIF
	IF MAXBASE:CCOUNT:敏捷 > GLOBAL:108
		GLOBAL:108 = MAXBASE:CCOUNT:敏捷
		GLOBALS:12 = %NAME:CCOUNT,40,LEFT%（Lv{ABL:CCOUNT:レベル}）　{GLOBAL:108}
	ENDIF
	IF MAXBASE:CCOUNT:知性 > GLOBAL:109
		GLOBAL:109 = MAXBASE:CCOUNT:知性
		GLOBALS:13 = %NAME:CCOUNT,40,LEFT%（Lv{ABL:CCOUNT:レベル}）　{GLOBAL:109}
	ENDIF
	SAVEGLOBAL
	;実績
	CALL GET_STATE_TROPHY,CCOUNT
NEXT

;**********************************************************
;ターン終了後に起きるイベント各種

;ボス出現停止フラグを折る
FLAG:49 = 0

;ボス触手のダメージ蓄積値が回復
IF FLAG:10 == 1 && FLAG:11 == 2
ELSE
	SETCOLOR 128,128,128
	SIF FLAG:999 == 1
		PRINTL DEBUG ボスのキズが回復
	RESETCOLOR
	FOR LOCAL,1,FLAG:3 + 1
		FLAG:(300 + LOCAL) -= RAND:3000000 + 8000000
		SIF FLAG:(300 + LOCAL) < 0
			FLAG:(300 + LOCAL) = 0
	NEXT
	FOR LOCAL,1,FLAG:4 + 1
		;ラスボス強化時は回復量が低下
		CALL LASTBOSS_REST
		FLAG:(400 + LOCAL) -= (RAND:3000000 + 1000000) / (2 + RESULT)
		SIF FLAG:(400 + LOCAL) < 0
			FLAG:(400 + LOCAL) = 0
	NEXT
ENDIF



;口上のターン終了時処理を呼び出し
FOR CCOUNT, 0, CHARANUM
	SIF CCOUNT == MASTER
		CONTINUE

	TARGET = CCOUNT
	CALL MESSAGE_TURNEND
NEXT

;TARGETの値を退避
FLAG:797 = TARGET

;クズ市民による脅迫あるいは誘拐監禁
FOR CCOUNT, 0, CHARANUM
	SIF CCOUNT == MASTER
		CONTINUE
	IF GROUPMATCH(CFLAG:CCOUNT:0,0,5) && (CFLAG:CCOUNT:286 + CFLAG:CCOUNT:320 + CFLAG:CCOUNT:321) > 0 ;一度でもレイプされたことがあれば発生
	TARGET = CCOUNT
	CALL INTIMIDATION_EVENT
	ELSEIF CFLAG:CCOUNT:0 == 4
	TARGET = CCOUNT
	CALL KIDNAPPING
	ENDIF
NEXT

;触手幽閉
CALL PRISON
;判定出産
CALL BIRTH_HANTEI
;判定育児終了
CALL GROW_HANTEI

;悪堕ちキャラが暴れるイベント
CALL AKUOTI_ATTACK

;イチャックス
CALL LOVESEX_NIGHT
;夜間自慰
CALL SELF_NIGHT
;夜這い
SIF CONFIG_CHECK_EVENT_F(2) > 0
	CALL YOBAI


;ゲームオーバーモードでは防衛力が０になる
IF FLAG:0 == 0
	FLAG:852 = 0
	FLAG:853 = LIMIT(FLAG:853, -100, 100)
ELSEIF DAY > 0
	;防衛力の自動変動
	IF (FLAG:41 == 0 && FLAG:0 != 2) || FLAG:52
		SIF FLAG:41 == 0 && FLAG:0 != 2
			FLAG:42 ++
		DRAWLINE
		PRINTL 
		FONTBOLD
		PRINTL 防衛力の変動　　
		IF FLAG:42 < FLAG:52
			PRINTFORML 　防衛設備が効果的に機能しています
		ELSEIF FLAG:42 < 2 + FLAG:52
			PRINTFORML 　危険度レベル{FLAG:42 - FLAG:52}：まだ比較的安全です
		ELSEIF FLAG:42 < 3 + FLAG:52
			PRINTFORML 　危険度レベル{FLAG:42 - FLAG:52}：まだ無視できるレベルです
		ELSEIF FLAG:42 < 5 + FLAG:52
			PRINTFORML 　危険度レベル{FLAG:42 - FLAG:52}：触手の活動が活発化しています
		ELSEIF FLAG:42 < 7 + FLAG:52
			PRINTFORML 　危険度レベル{FLAG:42 - FLAG:52}：あちこちで被害が多発中！
		ELSE
			PRINTFORML 　危険度レベルMAX：かなり危険な状態です！
		ENDIF
		FONTREGULAR
		PRINTFORM 　防衛力( {FLAG:852} )　
		;このターンに誰も出撃していない場合、放棄ターン数に応じて防衛力が大きく低下
		LOCAL:852 = 0
		IF FLAG:41 == 0 && FLAG:0 != 2
			CALL TENTACLE_LEVEL
			IF FLAG:42 < FLAG:52
				LOCAL:852 = 0
			ELSEIF FLAG:42 < 2 + FLAG:52
				LOCAL:852 = RESULT + 5
			ELSEIF FLAG:42 == 2 + FLAG:52
				LOCAL:852 = FLAG:852 * 1 / 100 + RESULT + 5
			ELSEIF FLAG:42 == 3 + FLAG:52
				LOCAL:852 = FLAG:852 * 4 / 100 + RESULT + 10
			ELSEIF FLAG:42 == 4 + FLAG:52
				LOCAL:852 = FLAG:852 * 8 / 100 + RESULT + 20
			ELSEIF FLAG:42 == 5 + FLAG:52
				LOCAL:852 = FLAG:852 * 12 / 100 + RESULT + 40
			ELSEIF FLAG:42 == 6 + FLAG:52
				LOCAL:852 = FLAG:852 * 15 / 100 + RESULT + 80
			ELSEIF FLAG:42 == 7 + FLAG:52
				LOCAL:852 = FLAG:852 * 20 / 100 + RESULT + 160
			ELSE
				LOCAL:852 = FLAG:852 * 50 / 100 + RESULT + 320
			ENDIF
			PRINTFORM −　時間経過( {LOCAL:852} )　
			FLAG:852 = MAX(FLAG:852 - LOCAL:852, 0)
		ELSE
			;誰かが出撃していれば放棄ターン数リセット
			FLAG:42 = 0
		ENDIF
		LOCAL:852 = FLAG:52 * FLAG:52 * 5
		;防衛設備が自動で防衛
		FLAG:852 = FLAG:852 + LOCAL:852
		SIF LOCAL:852
			PRINTFORM ＋　防衛設備Lv{FLAG:52}( {LOCAL:852} )　
		SIF (FLAG:41 == 0 && FLAG:0 != 2) || FLAG:52
			PRINTFORM ＝　{FLAG:852}
		PRINTL 
	ELSEIF FLAG:41 > 0
		FLAG:42 = 0
	ENDIF
	;人気度の自動変動
	FLAG:853 = LIMIT(FLAG:853, -100, 100)
	DRAWLINE
	PRINTL 
	FONTBOLD
	PRINTL 人気度の変動　　
	FONTREGULAR
	PRINTFORM 　人気度( {FLAG:853} )　
	;一般評価
	LOCAL:853 = 0
	LOCAL:0 = FLAG:853
	IF FLAG:852 == 0
		SIF RAND:100 < 5
			LOCAL:853 -= 1
		SIF RAND:100 < 5
			LOCAL:853 -= 1
		SIF RAND:100 < 5
			LOCAL:853 -= 1
	ELSEIF FLAG:852 < 1250
		SIF RAND:100 < 5
			LOCAL:853 -= 1
		SIF RAND:100 < 5
			LOCAL:853 -= 1
	ELSEIF FLAG:852 < 2500
		SIF RAND:100 < 5
			LOCAL:853 -= 1
		SIF RAND:100 < 5
			LOCAL:853 += 1
	ELSEIF FLAG:852 < 5000
		SIF RAND:100 < 5
			LOCAL:853 += 1
	ELSEIF FLAG:852 < 7500
		SIF RAND:100 < 5
			LOCAL:853 += 1
		SIF RAND:100 < 5
			LOCAL:853 += 1
	ELSE
		SIF RAND:100 < 5
			LOCAL:853 += 1
		SIF RAND:100 < 5
			LOCAL:853 += 1
		SIF RAND:100 < 5
			LOCAL:853 += 1
	ENDIF
	IF LOCAL:853 < 0
		RESULT = ABS(LOCAL:853)
		PRINTFORM −　一般評価( {RESULT} )　
	ENDIF
	SIF LOCAL:853 > 0
		PRINTFORM ＋　一般評価( {LOCAL:853} )　
	FLAG:853 = FLAG:853 + LOCAL:853
	;処女ボーナス
	LOCAL:853 = 0
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		IF TALENT:CCOUNT:処女 > 0
			SIF RAND:100 < 5
				LOCAL:853 += 1
		ELSEIF CHARATALENT_F(CCOUNT,0,"オトコ") > 0 && CHARATALENT_F(CCOUNT,1,"オトコ") == 0 && TALENT:CCOUNT:変身時非処女 == 0
			SIF RAND:100 < 5
				LOCAL:853 += 1
		ENDIF
	NEXT
	SIF LOCAL:853 > 0
		PRINTFORM ＋　処女ボーナス( {LOCAL:853} )　
	FLAG:853 = FLAG:853 + LOCAL:853
	;ファン人気
	LOCAL:853 = 0
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		IF EXP:CCOUNT:魅了経験 >= 200
			SIF RAND:100 < 5
				LOCAL:853 += 1
			SIF EXP:CCOUNT:魅了経験 >= 500 && RAND:100 < 5
				LOCAL:853 += 1
			SIF EXP:CCOUNT:魅了経験 >= 3000 && RAND:100 < 5
				LOCAL:853 += 1
		ENDIF
		SIF TALENT:CCOUNT:清純派 > 0 && RAND:100 < 5
			LOCAL:853 += 1
		SIF RAND:100 < MIN(CFLAG:CCOUNT:284 / 4, 10)
			LOCAL:853 += 1
		;性格補正
		SIF TALENT:CCOUNT:母性的 > 0 && RAND:100 < 5
			LOCAL:853 += 1
		SIF TALENT:CCOUNT:小悪魔 > 0 && RAND:100 < 5
			LOCAL:853 += 1
		SIF TALENT:CCOUNT:目立ちたがり > 0 && RAND:100 < 5
			LOCAL:853 += 1
		SIF TALENT:CCOUNT:上品 > 0 && RAND:100 < 5
			LOCAL:853 += 1
		SIF TALENT:CCOUNT:泣き虫 > 0 && RAND:100 < 5
			LOCAL:853 += 1
		;FEATによる人気度への補正
		SIF TALENT:CCOUNT:獣性の証 > 0 && RAND:100 < 5
			LOCAL:853 += 1
		SIF TALENT:CCOUNT:人外の美貌 > 0 && RAND:100 < 10
			LOCAL:853 += 1
	NEXT
	SIF LOCAL:853 > 0
		PRINTFORM ＋　ファン人気( {LOCAL:853} )　
	FLAG:853 = FLAG:853 + LOCAL:853
	;悪いうわさ
	LOCAL:853 = 0
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		SIF RAND:30 < MIN(CFLAG:825, 10)
			LOCAL:853 += 2
	NEXT
	SIF LOCAL:853 > 0
		PRINTFORM −　悪いうわさ( {LOCAL:853} )
	FLAG:853 = FLAG:853 - LOCAL:853
	FLAG:853 = LIMIT(FLAG:853, -100, 100)
	PRINTFORM ＝　{FLAG:853}　
	IF FLAG:853 < LOCAL:0
		PRINT (↓下降)
	ELSEIF FLAG:853 > LOCAL:0
		PRINT (↑上昇)
	ELSE
		PRINT (変動なし)
	ENDIF
	PRINTL 
	DRAWLINE
	PRINTL 
	SIF CONFIG_CHECK_SCREEN_F(3) == 0
		WAIT
ENDIF
LOCAL:852 = 0
LOCAL:853 = 0

;判定ボス触手襲来
SIF CONFIG_CHECK_EVENT_F(0) > 0
	CALL RAID_HANTEI
SIF FLAG:45 > 0
	GOTO RAID_SKIP
$AFTER_RAID

;寄生関係
CALL PARASITE
;子触手襲来
SIF CONFIG_CHECK_EVENT_F(1) > 0
	CALL SMALL_TENTACLE_HANTEI
;子触手の増殖
CALL AUTO_BIRTH

;同時出撃人数と戦闘支援人数をリセット
FLAG:41 = 0
FLAG:43 = 0
;TARGETを元に戻す
TARGET = FLAG:797

;**********************************************************

;昼夜の切り替え
INVERTBIT TIME, 0

;時間経過で自動的に体力,気力,性耐性,結界,淫紋が回復する
FOR CCOUNT, 0, CHARANUM
	SIF CCOUNT == MASTER
		CONTINUE
	
	;一日が経過した直後（昼）だと回復量8%
	IF TIME == 0
		LOCAL:1 = 8
		IF TALENT:CCOUNT:回復早い == 1
			LOCAL:1 += 4
		ELSEIF TALENT:CCOUNT:回復遅い == 1
			LOCAL:1 -= 4
		ENDIF

		;自動回復アップの効果
		SIF FLAG:901
			LOCAL:1 += 4
	ELSE
		LOCAL:1 = 0
		;FEAT効果による回復量補正
		SIF TALENT:夜魔の貴族 > 0
			LOCAL:1 += 8
	ENDIF
    
		;射精しすぎて回復に影響
		SIF CFLAG:CCOUNT:37 > 2
		    LOCAL:1 -= (CFLAG:CCOUNT:37)/2
		SIF CFLAG:CCOUNT:38 > 0
		    LOCAL:1 -= 4
		
		;レイプや処女喪失など不幸事件により回復影響
		IF CFLAG:CCOUNT:15 > 0
		   LOCAL:1 -= 2*(CFLAG:CCOUNT:15)
		   CFLAG:CCOUNT:15 -= 1
		ENDIF

		SIF CFLAG:CCOUNT:72 > 0
		   CFLAG:CCOUNT:72 -= 1

	;射精回数回復
	IF TIME == 0
       SIF CFLAG:CCOUNT:37 > 0
	       CFLAG:CCOUNT:37 = 0
	   SIF CFLAG:CCOUNT:38 > 0
	       CFLAG:CCOUNT:38 = 0
	ELSE
	   SIF CFLAG:CCOUNT:37 >= 2 && CFLAG:CCOUNT:38 < 1
	       CFLAG:CCOUNT:37 -= 2
	ENDIF


	;休憩設備レベルに応じて自動回復
	IF FLAG:51 == 1
		LOCAL:1 += 0
	ELSEIF FLAG:51 == 2
		LOCAL:1 += 2
	ELSEIF FLAG:51 == 3
		LOCAL:1 += 4
	ELSEIF FLAG:51 == 4
		LOCAL:1 += 6
	ELSEIF FLAG:51 == 5
		LOCAL:1 += 8
	ENDIF

	SIF FLAG:54 && EXP:CCOUNT:魅了経験 >= 200
	    EXP:CCOUNT:魅了経験 += RAND:10

	;幽閉、監禁、洗脳、悪堕ち、死亡、消沈中のキャラは体力気力性耐性が０になる
	IF CFLAG:CCOUNT:15 > 3 || CFLAG:CCOUNT:0 == 1 || CFLAG:CCOUNT:0 == 2 || CFLAG:CCOUNT:0 == 3 || CFLAG:CCOUNT:0 == 4 || CFLAG:CCOUNT:0 == 5 || CFLAG:CCOUNT:0 == 9
		BASE:CCOUNT:体力 = 0
		BASE:CCOUNT:気力 = 0
		BASE:CCOUNT:性耐性 = 0
	;回復の処理
	ELSE
		LOCAL = MAXBASE:CCOUNT:体力
		LOCAL = LOCAL * LOCAL:1 / 100
		BASE:CCOUNT:体力 = LIMIT(LOCAL + BASE:CCOUNT:体力, 0, MAXBASE:CCOUNT:体力)

		LOCAL = MAXBASE:CCOUNT:気力
		LOCAL = LOCAL * LOCAL:1 / 100
		BASE:CCOUNT:気力 = LIMIT(LOCAL + BASE:CCOUNT:気力, 0, MAXBASE:CCOUNT:気力)

		LOCAL = MAXBASE:CCOUNT:性耐性	
		LOCAL = LOCAL * LOCAL:1 / 100
		BASE:CCOUNT:性耐性 = LIMIT(LOCAL + BASE:CCOUNT:性耐性, 0, MAXBASE:CCOUNT:性耐性)
	ENDIF

	;疲労度自動回復の処理
	IF CFLAG:CCOUNT:99 > 0 && CFLAG:CCOUNT:0 == 0
		LOCAL = 0
		SIF (FLAG:53 & 観葉植物) && RAND:2 == 0
			LOCAL += 1
		SIF (FLAG:53 & 心休まる風景画) && RAND:3 == 0
			LOCAL += 1
		SIF (FLAG:53 & オシャレなオブジェ) && RAND:4 == 0
			LOCAL += 1
		SIF (FLAG:53 & ゴージャスな噴水) && RAND:2 == 0
			LOCAL += 1
		SIF (FLAG:53 & マッサージチェア)
			LOCAL += 1
		SIF (FLAG:53 & ビューティサロン)
			LOCAL += 2

		SIF CFLAG:CCOUNT:100 == 102 && (FLAG:53 & シャワー設備)
			LOCAL += 1

		;FEAT効果による疲労の自動回復
		SIF TALENT:CCOUNT:不老長寿 > 0 && TIME == 0
			LOCAL += 1
		SIF TALENT:CCOUNT:不老長寿 > 0 && TIME == 0 && RAND:2 == 0
			LOCAL += 1
		SIF TALENT:CCOUNT:不老長寿 > 0 && TIME == 0 && RAND:2 == 0
			LOCAL += 1
		SIF TALENT:CCOUNT:不老長寿 > 0 && TIME == 1
			LOCAL += 1
		SIF TALENT:CCOUNT:不老長寿 > 0 && TIME == 1 && RAND:2 == 0
			LOCAL += 1

		SIF CFLAG:CCOUNT:99 <= 0
			LOCAL = 0

		;回復実行
		CFLAG:CCOUNT:99 -= LOCAL
		SIF CFLAG:CCOUNT:99 < 0
			CFLAG:CCOUNT:99 = 0

		IF CFLAG:CCOUNT:100 != 103 && LOCAL > 0
			IF CFLAG:CCOUNT:99 == 0
				PRINTFORML %CALLNAME:CCOUNT%の身体から疲労が完全に抜けた！
			ELSE
				PRINTFORML %CALLNAME:CCOUNT%の身体から疲労が少し抜けた…
			ENDIF
		ENDIF
	ENDIF

	;部位結界の回復
	FOR LCOUNT, 0, 感覚数
		LOCAL = 0
		IF CFLAG:CCOUNT:0 == 0
			LOCAL = 3
			SIF CFLAG:CCOUNT:100 == 103
				LOCAL += 3
		ENDIF
		LOCAL = MAXBASE:CCOUNT:(LCOUNT + 30) * LOCAL / 100
		SIF BASE:CCOUNT:(LCOUNT + 30) > 0
			BASE:CCOUNT:(LCOUNT + 30) = LIMIT(BASE:CCOUNT:(LCOUNT + 30) + LOCAL, 0, MAXBASE:CCOUNT:(LCOUNT + 30))
	NEXT

	;社交的な場合、低確率でストーカーフラグが増加
	SIF TALENT:CCOUNT:社交的 > 0 && RAND:100 < (4 + SQRT(EXP:CCOUNT:魅了経験))
		CFLAG:CCOUNT:285 += 1
	;小心者の場合、低確率でストーカーフラグが減少
	SIF TALENT:CCOUNT:社交的 > 0 && RAND:100 < 8 && CFLAG:CCOUNT:285 > 0
		CFLAG:CCOUNT:285 -= 1

	;避妊用ピルを処方していれば１つ消費
	SIF CFLAG:CCOUNT:241 > 0
		CFLAG:CCOUNT:241 -= 1
NEXT

;日数
DRAWLINE
IF TIME == 0
	DAY += 1
	IF DAY > 1
		PRINTL 一日が終了しました
		FLAG:60 = 0

		IF FLAG:0 != 0
			IF DAY == 7
				PRINTW 国から支援表明の通知が届きました。
				PRINTW これからは一週間ごとに政府からの支援と市民からの義援金が届きます。
				PRINTW 防衛成果に応じて金額が増えるので、防衛力に注意しましょう。
				PRINTL 
				PRINTL 最初の資金援助が届いています。
				PRINTW 
			ELSEIF DAY == 21
				PRINTL 国からの援助金が増額されました。
				PRINTW 
			ELSEIF DAY == 42
				PRINTL 不況の影響で、国からの援助金が大幅に減額されました。
				PRINTW 
			ELSEIF DAY == 63
				PRINTL 不況の影響で、国からの援助金が打ち切られました。
				PRINTW 
			ENDIF

			;資金援助
			IF DAY % 7 == 0
				LOCAL = 1000 + ((FLAG:852 +1) / 25)
				LOCAL:1 = RAND:((FLAG:852 +1) / 10 + 50) + 10
				IF FLAG:853 <= -50
					LOCAL:2 = 0
				ELSeIF FLAG:853 <= -25
					LOCAL:2 = 200
				ELSEIF FLAG:853 < 0
					LOCAL:2 = 600
				ELSEIF FLAG:853 < 25
					LOCAL:2 = 1200
				ELSEIF FLAG:853 < 50
					LOCAL:2 = 1800
				ELSEIF FLAG:853 < 75
					LOCAL:2 = 3600
				ELSE
					LOCAL:2 = 7200
				ENDIF
				FOR CCOUNT, 0, CHARANUM
					SIF CCOUNT == MASTER
						CONTINUE
					SIF EXP:CCOUNT:魅了経験 > 100
						LOCAL:2 += SQRT(MAX(EXP:CCOUNT:魅了経験 - 100, 0)) * 500 + RAND:(EXP:CCOUNT:魅了経験)
				NEXT
				SIF DAY >= 21
					LOCAL += 800
				SIF DAY >= 42
					LOCAL /= 4
				SIF DAY >= 63
					LOCAL = 0
				SIF DAY < 63
					PRINTFORML 政府からの援助金として資金${LOCAL}を得た！
				PRINTFORML 市民からの義援金として資金${LOCAL:1 + LOCAL:2}を得た！
				MONEY += LOCAL + LOCAL:1 + LOCAL:2
			ENDIF

			;支出
			CALL GET_DAILYFEE
			IF FLAG:30 > 0 && FLAG:854 > 0
			LOCAL:2 = 100 + 100 * CHARANUM_ALIVE()
			ELSE
			LOCAL:2 = 40 + 20 * CHARANUM_ALIVE()
			ENDIF
			
			SIF FLAG:0 == 4
				LOCAL:2 *= 3

			SIF FLAG:30 > 0 && FLAG:854 > 0
			    LOCAL:2 += 維持費

			IF MONEY >= LOCAL:2
				PRINTFORML 維持費や生活費として資金${LOCAL:2}を支払った。
				MONEY -= LOCAL:2
				WAIT
			ELSE
				PRINTFORML 維持費や生活費のための資金が不足しています！
				PRINTFORML 体力と気力を消耗しました……
				WAIT
				MONEY = 0
				FOR CCOUNT, 0, CHARANUM
					TIMES BASE:CCOUNT:体力 , 0.6
					TIMES BASE:CCOUNT:気力 , 0.6
				NEXT
				IF FLAG:30 > 0 && FLAG:854 > 0 && (FLAG:50 + FLAG:51 + FLAG:52) > 0
				PRINTFORML 資金不足のため、施設のレベルが下がった。。
				FLAG:50 = LIMIT(FLAG:50-1,0,5)
				FLAG:51 = LIMIT(FLAG:51-1,0,5)
				FLAG:52 = LIMIT(FLAG:52-1,0,5)
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ELSE
	PRINTL 夜になりました
	WAIT
ENDIF
;日数ごとに固定のニュースを表示
IF FLAG:0 == 0
	FLAG:60 = 10001
ELSEIF GETBIT(FLAG:101,1)
	FLAG:60 = 10000
ELSEIF DAY == 1
	FLAG:60 = 10002
ELSEIF DAY == 3
	FLAG:60 = 10003
ELSEIF DAY == 6
	FLAG:60 = 10004
ELSEIF DAY == 20
	FLAG:60 = 10005
ELSEIF DAY == 23
	FLAG:60 = 10006
ELSEIF DAY == 30
	FLAG:60 = 10007
ELSEIF DAY == 41
	FLAG:60 = 10008
ELSEIF DAY == 44
	FLAG:60 = 10009
ELSEIF DAY == 51
	FLAG:60 = 10010
ELSEIF DAY == 62
	FLAG:60 = 10011
ELSEIF DAY == 63
	FLAG:60 = 10012
ELSEIF DAY == 15
	FLAG:60 = 10013
ENDIF

;TARGETを元に戻す
TARGET = FLAG:798
$RAID_SKIP
;全キャラの結界状態をチェック
CALL CHECK_SHIELD_ALL

;--------------------------------------------------
@EVENTLOAD
REDRAW 0
CALL UPDATE
IF FLAG:999 == 1
	SETBGCOLOR 0,0,40
ELSE
	RESETBGCOLOR
ENDIF
SIF FLAG:64 > 0
	JUMP ENDING

@UPDATE_GLOBAL
;グローバルをアップデート
IF GLOBAL:3 < 364
	GLOBAL:3 = 364
	;プロフィール表示グローバルを消去
	GLOBAL:9 = 0
	SAVEGLOBAL
ENDIF
IF GLOBAL:3 < 371
	GLOBAL:3 = 371
	MOB_FLAG:0:1 = 100
	MOB_GLOBAL:0:1 = 100
	SAVEGLOBAL
ENDIF
IF GLOBAL:3 < 380
	GLOBAL:3 = 380
	GLOBAL:0 = 0
	GLOBAL:1 = 0
	GLOBAL:2 = 0
	;コンフィグを初期設定に変更
	GLOBAL:10 = 0
	GLOBAL:11 = 4
	GLOBAL:12 = 31
	GLOBAL:13 = 88
	GLOBAL:14 = 5
	SAVEGLOBAL
ENDIF
IF GLOBAL:3 < 390
	GLOBAL:3 = 390
	;拡張度フィルターの値を反転
	INVERTBIT GLOBAL:4,16
	INVERTBIT GLOBAL:4,17
ENDIF

@UPDATE
#DIM CCOUNT
PRINTL 
;グローバルデータ管理***************************
LOADGLOBAL
IF RESULT == 1
	;コンフィグデータ読み込み
	IF CONFIG_CHECK_MAIN_F(0) > 0
		SIF GLOBAL:0 + GLOBAL:1 + GLOBAL:2 != 0
			PRINTW 【コンフィグ設定を読み込みました】
		FLAG:801 = GLOBAL:11
		FLAG:802 = GLOBAL:12
		FLAG:803 = GLOBAL:13
		FLAG:804 = GLOBAL:14
	ENDIF
	;性嗜好フィルタは常に適用する
	FLAG:850 = GLOBAL:4
	;雑魚敵フィルタは常に適用する
	FOR LOCAL,0,MOB_CATEGORY
		FOR LOCAL:1,0,100
			TRYCCALLFORM TENTACLE_MOB_{LOCAL * 100 + LOCAL:1}
				MOB_FLAG:LOCAL:(LOCAL:1) = MOB_GLOBAL:LOCAL:(LOCAL:1)
			CATCH
				MOB_FLAG:LOCAL:(LOCAL:1) = 0
			ENDCATCH
		NEXT
	NEXT
	;グローバルのアップデート
	CALL UPDATE_GLOBAL
ENDIF
;アップデート用********************************
IF LASTLOAD_VERSION < 190 && LASTLOAD_VERSION != -1
	IF FLAG:8 == 0
		LOCAL = 0
		LOCAL:1 = TARGET
		FOR LOCAL,0,CHARANUM
			TARGET = LOCAL
			SIF CFLAG:240 == 0
				CFLAG:240 = LOCAL
		NEXT
		TARGET = LOCAL:1
		FLAG:8 = 3
	ENDIF
	SIF FLAG:51 < 100
		FLAG:51 = 100
	SIF FLAG:100 < 0
		FLAG:100 = 0
	SIF FLAG:101 < 0
		FLAG:101 = 0
ENDIF
IF LASTLOAD_VERSION < 191 && LASTLOAD_VERSION != -1
	;専用口上の番号を設定
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		CFLAG:CCOUNT:6 = NO:CCOUNT
	NEXT
ENDIF
IF LASTLOAD_VERSION < 200 && LASTLOAD_VERSION != -1
	;各キャラに知性を追加
	FOR LOCAL, 0, CHARANUM
		SIF LOCAL == MASTER
			CONTINUE
		IF BASE:LOCAL:知性 <= 0
			BASE:LOCAL:知性 = 100
			MAXBASE:LOCAL:知性 = LEVELSTATUS_UP(BASE:LOCAL:知性,ABL:LOCAL:レベル)
		ENDIF
	NEXT
ENDIF
IF LASTLOAD_VERSION < 210 && LASTLOAD_VERSION != -1
	SIF FLAG:51 >= 100
		FLAG:51 /= 100
ENDIF
IF LASTLOAD_VERSION < 212 && LASTLOAD_VERSION != -1
	;口上のCFLAG振り直しを反映
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE

		;ヤンデレ
		IF SEIKAKU_CHECK_F(CCOUNT) == 21
			SWAP CFLAG:CCOUNT:250,CFLAG:CCOUNT:279
			SWAP CFLAG:CCOUNT:251,CFLAG:CCOUNT:280
		ELSE
			;口上用フラグを初期化
			FOR LOCAL,250,282
				CFLAG:CCOUNT:LOCAL = 0
			NEXT
		ENDIF
	NEXT
ENDIF
IF LASTLOAD_VERSION < 231 && LASTLOAD_VERSION != -1
	;ボスダメージ蓄積値を1000000倍に
	FOR LOCAL,300,500
		FLAG:LOCAL *= 1000000
	NEXT
ENDIF
IF LASTLOAD_VERSION < 241 && LASTLOAD_VERSION != -1
	FOR CCOUNT, 0, CHARANUM
		IF NAME:CCOUNT == "汎用キャラ" || CALLNAME:CCOUNT == "LOCALS:1"
			;母親サーチ
			FOR LOCAL,0,CHARANUM
				SIF LOCAL == MASTER
					CONTINUE
				SIF CFLAG:LOCAL:240 == CFLAG:CCOUNT:7
					CSTR:CCOUNT:10 = %CSTR:CCOUNT:LOCAL%
			NEXT
			PRINTFORML 名前がおかしいキャラを発見しました
			PRINTFORM 名前を再入力してください
			SIF CSTR:CCOUNT:10 != ""
				PRINTFORM （母親から受け継いだ苗字『%CSTR:CCOUNT:10%』）
			PRINTL 
			PRINTW 
			CALL FIRSTSETTING_CHARA_NAME, CCOUNT
		ENDIF
	NEXT
ENDIF
IF LASTLOAD_VERSION < 263 && LASTLOAD_VERSION != -1
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		IF MAXBASE:CCOUNT:体力 <= 0 || MAXBASE:CCOUNT:気力 <= 0 || MAXBASE:CCOUNT:性耐性 <= 0
			;まずキャラの基礎値から設定を試みる
			IF MAXBASE:CCOUNT:体力 <= 0 && BASE:CCOUNT:体力基礎
				MAXBASE:CCOUNT:体力 = LEVELSTATUS_UP(BASE:CCOUNT:体力基礎,ABL:CCOUNT:レベル,400+(BASE:体力基礎-1000)/5)
				BASE:CCOUNT:体力 = MAXBASE:CCOUNT:体力
				PRINTFORML 体力最大値がおかしいキャラの能力値を修正しました
			ENDIF
			IF MAXBASE:CCOUNT:気力 <= 0 && BASE:CCOUNT:気力基礎
				MAXBASE:CCOUNT:気力 = LEVELSTATUS_UP(BASE:CCOUNT:気力基礎,ABL:CCOUNT:レベル,400+(BASE:気力基礎-1000)/5)
				BASE:CCOUNT:気力 = MAXBASE:CCOUNT:気力
				PRINTFORML 気力最大値がおかしいキャラの能力値を修正しました
			ENDIF
			IF MAXBASE:CCOUNT:性耐性 <= 0 && BASE:CCOUNT:性耐性基礎
				MAXBASE:CCOUNT:性耐性 = LEVELSTATUS_UP(BASE:CCOUNT:性耐性基礎,ABL:CCOUNT:レベル,10+(BASE:性耐性基礎-100)/10)
				BASE:CCOUNT:性耐性 = MAXBASE:CCOUNT:性耐性
				PRINTFORML 性耐性最大値がおかしいキャラの能力値を修正しました
			ENDIF
		ENDIF
		IF MAXBASE:CCOUNT:体力 <= 0 || MAXBASE:CCOUNT:気力 <= 0 || MAXBASE:CCOUNT:性耐性 <= 0
			;それでも駄目なら母親サーチ
			FOR LOCAL,0,CHARANUM
				SIF LOCAL == MASTER
					CONTINUE
				SIF CFLAG:LOCAL:240 == CFLAG:CCOUNT:7
					LOCAL:1 = LOCAL
			NEXT
			IF LOCAL:1
				IF MAXBASE:CCOUNT:体力 <= 0
					BASE:CCOUNT:体力基礎 = BASE:(LOCAL:1):体力基礎*6/10 + 300 + RAND:400
					;性格補正
					BASE:CCOUNT:体力基礎 = SEIKAKU_HOSEI_F(SEIKAKU_CHECK_F(CCOUNT), 50, BASE:CCOUNT:体力基礎)
					MAXBASE:CCOUNT:体力 = LEVELSTATUS_UP(BASE:CCOUNT:体力基礎,ABL:CCOUNT:レベル,400+(BASE:体力基礎-1000)/5)
					BASE:CCOUNT:体力 = MAXBASE:CCOUNT:体力
					PRINTFORML 体力最大値がおかしいキャラの能力値を修正しました
				ENDIF
				IF MAXBASE:CCOUNT:気力 <= 0
					BASE:CCOUNT:気力基礎 = BASE:(LOCAL:1):気力基礎*6/10 + 300 + RAND:400
					;性格補正
					BASE:CCOUNT:気力基礎 = SEIKAKU_HOSEI_F(SEIKAKU_CHECK_F(CCOUNT), 51, BASE:CCOUNT:気力基礎)
					MAXBASE:CCOUNT:気力 = LEVELSTATUS_UP(BASE:CCOUNT:気力基礎,ABL:CCOUNT:レベル,400+(BASE:気力基礎-1000)/5)
					BASE:CCOUNT:気力 = MAXBASE:CCOUNT:気力
					PRINTFORML 気力最大値がおかしいキャラの能力値を修正しました
				ENDIF
				IF MAXBASE:CCOUNT:性耐性 <= 0
					BASE:CCOUNT:性耐性基礎 = BASE:(LOCAL:1):性耐性基礎*6/10 + 300 + RAND:400
					;性格補正
					BASE:CCOUNT:性耐性基礎 = SEIKAKU_HOSEI_F(SEIKAKU_CHECK_F(CCOUNT), 52, BASE:CCOUNT:性耐性基礎)
					MAXBASE:CCOUNT:性耐性 = LEVELSTATUS_UP(BASE:CCOUNT:性耐性基礎,ABL:CCOUNT:レベル,10+(BASE:性耐性基礎-100)/10)
					BASE:CCOUNT:性耐性 = MAXBASE:CCOUNT:性耐性
					PRINTFORML 性耐性最大値がおかしいキャラの能力値を修正しました
				ENDIF
			;それでも駄目なら基本値を設定
			ELSE
				IF MAXBASE:CCOUNT:体力 <= 0
					BASE:CCOUNT:体力基礎 = 1000
					;性格補正
					BASE:CCOUNT:体力基礎 = SEIKAKU_HOSEI_F(SEIKAKU_CHECK_F(CCOUNT), 50, BASE:CCOUNT:体力基礎)
					MAXBASE:CCOUNT:体力 = LEVELSTATUS_UP(BASE:CCOUNT:体力基礎,ABL:CCOUNT:レベル,400+(BASE:体力基礎-1000)/5)
					BASE:CCOUNT:体力 = MAXBASE:CCOUNT:体力
					PRINTFORML 体力最大値がおかしいキャラの能力値を修正しました
				ENDIF
				IF MAXBASE:CCOUNT:気力 <= 0
					BASE:CCOUNT:気力基礎 = 1000
					;性格補正
					BASE:CCOUNT:気力基礎 = SEIKAKU_HOSEI_F(SEIKAKU_CHECK_F(CCOUNT), 51, BASE:CCOUNT:気力基礎)
					MAXBASE:CCOUNT:気力 = LEVELSTATUS_UP(BASE:CCOUNT:気力基礎,ABL:CCOUNT:レベル,400+(BASE:気力基礎-1000)/5)
					BASE:CCOUNT:気力 = MAXBASE:CCOUNT:気力
					PRINTFORML 気力最大値がおかしいキャラの能力値を修正しました
				ENDIF
				IF MAXBASE:CCOUNT:性耐性 <= 0
					BASE:CCOUNT:性耐性基礎 = 100
					;性格補正
					BASE:CCOUNT:性耐性基礎 = SEIKAKU_HOSEI_F(SEIKAKU_CHECK_F(CCOUNT), 52, BASE:CCOUNT:性耐性基礎)
					MAXBASE:CCOUNT:性耐性 = LEVELSTATUS_UP(BASE:CCOUNT:性耐性基礎,ABL:CCOUNT:レベル,10+(BASE:性耐性基礎-100)/10)
					BASE:CCOUNT:性耐性 = MAXBASE:CCOUNT:性耐性
					PRINTFORML 性耐性最大値がおかしいキャラの能力値を修正しました
				ENDIF
			ENDIF
		ENDIF
		CALL LEVELSTATUS,CCOUNT
	NEXT
ENDIF
IF LASTLOAD_VERSION < 290 && LASTLOAD_VERSION != -1
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		;ステータスの再計算
		CALL LEVELSTATUS,CCOUNT
		;パーティ参加フラグを立てる
		SIF CCOUNT <= パーティ人数最大値
			CFLAG:CCOUNT:999 = 1
	NEXT
	CALL SET_PARTYMEMBER
ENDIF
IF LASTLOAD_VERSION < 300 && LASTLOAD_VERSION != -1
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		;全キャラのＳＰ変身補正率をCSVファイルの記述に合わせる
		CFLAG:CCOUNT:11 = CSVCFLAG_F(NO:CCOUNT,11)
	NEXT
ENDIF
IF LASTLOAD_VERSION < 312 && LASTLOAD_VERSION != -1
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		;全キャラの髪型をデフォルトにセット
		CSTR:CCOUNT:12 = %CSVCSTR(NO:CCOUNT,12)%
		CSTR:CCOUNT:13 = %CSVCSTR(NO:CCOUNT,13)%
		CSTR:CCOUNT:14 = %CSVCSTR(NO:CCOUNT,14)%
	NEXT
ENDIF
IF LASTLOAD_VERSION < 314 && LASTLOAD_VERSION != -1
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		;全キャラのEQUIPをリセット
		FOR LOCAL, 0, 1000
			EQUIP:CCOUNT:LOCAL = 0
		NEXT
	NEXT
ENDIF
IF LASTLOAD_VERSION < 320 && LASTLOAD_VERSION != -1
	FLAG:854 = FLAG:853
	FLAG:853 = 0
	ITEM:299 = ITEM:204
	ITEM:204 = 0
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		;修練Pが0未満になっているなら0にする
		SIF JUEL:CCOUNT:修練P < 0
			JUEL:CCOUNT:修練P = 0
		;アクセサリ4番以降を外見に移動させる
		IF TALENT:CCOUNT:アクセサリ > 3
			TALENT:CCOUNT:外見 = TALENT:CCOUNT:アクセサリ - 3
			TALENT:CCOUNT:アクセサリ = 0
		ENDIF
		;ソフトボディスーツを着ている場合は番号を差し替え
		SIF CFLAG:CCOUNT:41 == 204
			CFLAG:CCOUNT:41 = 299
	NEXT
ENDIF
IF LASTLOAD_VERSION < 321 && LASTLOAD_VERSION != -1
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		;汎用キャラの口調を設定
		SIF NO:CCOUNT == 0 && TALENT:CCOUNT:オトコ > 0
			CFLAG:CCOUNT:6 = 1
		SIF NO:CCOUNT == 0 && TALENT:CCOUNT:ロボっ子 > 0
			CFLAG:CCOUNT:6 = 2
		SIF CHARATALENT_F(CCOUNT,0,"オトコ") != CHARATALENT_F(CCOUNT,1,"オトコ")
			TALENT:CCOUNT:変身時ＴＳ = 1
		SIF CSVTALENT_F(NO:CCOUNT,0) == 1 && TALENT:CCOUNT:処女 == 0
			TALENT:CCOUNT:処女 = -1
	NEXT
ENDIF
IF LASTLOAD_VERSION < 341 && LASTLOAD_VERSION != -1
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		;全キャラの空中ダッシュ回数をCSVファイルの記述に合わせる
		MAXBASE:CCOUNT:空中ダッシュ = CSVBASE_F(NO:CCOUNT,22)
		SIF TALENT:CCOUNT:空中得意
			MAXBASE:CCOUNT:空中ダッシュ = MIN(MAXBASE:CCOUNT:空中ダッシュ + 1, 5)
		SIF TALENT:CCOUNT:空中苦手
			MAXBASE:CCOUNT:空中ダッシュ = MAX(MAXBASE:CCOUNT:空中ダッシュ - 1, 0)
		BASE:CCOUNT:空中ダッシュ = MAXBASE:CCOUNT:空中ダッシュ
		;体力気力ボーナスの上昇量を半減
		BASE:CCOUNT:体力基礎 -= CFLAG:CCOUNT:50 * 10
		BASE:CCOUNT:気力基礎 -= CFLAG:CCOUNT:51 * 10
		;ステータスの再計算
		CALL LEVELSTATUS,CCOUNT

		;素質基本値を記録
		BASE:CCOUNT:48 = BASE:CCOUNT:42
		MAXBASE:CCOUNT:48 = MAXBASE:CCOUNT:42

		;存在しなくなった衣装を装備から外す
		SIF CFLAG:CCOUNT:41 == 203
			CFLAG:CCOUNT:41 = 0
	NEXT
	SIF ITEM:201 > 0
		MONEY += 5500
	SIF ITEM:202 > 0
		MONEY += 5500
	SIF ITEM:203 > 0
		MONEY += 8500
	SIF ITEM:299 > 0
		MONEY += 2500
	ITEM:201 = 1
	ITEM:202 = 1
	ITEM:203 = 0
	ITEM:299 = 1
ENDIF
IF LASTLOAD_VERSION < 342 && LASTLOAD_VERSION != -1
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE

		IF TALENT:CCOUNT:妊娠 > 0
			CFLAG:CCOUNT:227 = NUM_CHILD_TENTACLE(CCOUNT)
			CFLAG:CCOUNT:228 = PREGNANT_RANDOM_SIZE(CCOUNT)
		ENDIF

		SIF CFLAG:CCOUNT:0 == 3
			EXP:CCOUNT:陥落経験 += 1
	NEXT
	;邪悪なる魔装を所持していないなら増やしておく
	SIF ITEM:401 == 0
		ITEM:401 += 1
ENDIF
IF LASTLOAD_VERSION < 351 && LASTLOAD_VERSION != -1
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE

		SIF TALENT:CCOUNT:妊娠 > 0 && CFLAG:CCOUNT:228 == 0
			CFLAG:CCOUNT:228 = PREGNANT_RANDOM_SIZE(CCOUNT)

		CALL SET_PARTYMEMBER
	NEXT
ENDIF
IF LASTLOAD_VERSION < 360 && LASTLOAD_VERSION != -1
	;フラグの更新
	FLAG:49 = FLAG:47
	LOCAL = FLAG:46
	CALL MOB_KILL_QUOTA
	LOCAL = 100 - PERCENT_CAL_F(LOCAL, RESULT)
	CALL RESEARCH_QUOTA
	FLAG:47 = FLAG:46 * LOCAL / 100
	SIF FLAG:47 < 0
		FLAG:47 = 0
	;一部衣装の払い戻し
	IF ITEM:128 > 0
		ITEM:128 = 0
		MONEY += 4000
		FOR LOCAL, 0, CHARANUM
			SIF LOCAL == MASTER
				CONTINUE
			SIF CFLAG:LOCAL:40 == 128 || CFLAG:LOCAL:41 == 128
				PRINTFORML %CALLNAME:LOCAL%の衣装が外れました。
			SIF CFLAG:LOCAL:40 == 128
				CFLAG:LOCAL:40 = 0
			SIF CFLAG:LOCAL:41 == 128
				CFLAG:LOCAL:40 = 0
		NEXT
	ENDIF
	IF ITEM:129 > 0
		ITEM:129 = 0
		MONEY += 4000
		FOR LOCAL, 0, CHARANUM
			SIF LOCAL == MASTER
				CONTINUE
			SIF CFLAG:LOCAL:40 == 129 || CFLAG:LOCAL:41 == 129
				PRINTFORML %CALLNAME:LOCAL%の衣装が外れました。
			SIF CFLAG:LOCAL:40 == 129
				CFLAG:LOCAL:40 = 0
			SIF CFLAG:LOCAL:41 == 129
				CFLAG:LOCAL:40 = 0
		NEXT
	ENDIF
	;バグで消えたアイテムの復活
	ITEM:200 = 1
	ITEM:201 = 1
	ITEM:202 = 1
	ITEM:299 = 1
ENDIF
IF LASTLOAD_VERSION < 363 && LASTLOAD_VERSION != -1
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE

		LOCAL:9 = 0
		LOCAL:230 = 0
		CFLAG:CCOUNT:9 = LOCAL:9
		CFLAG:CCOUNT:230 = LOCAL:230
		IF CFLAG:CCOUNT:9 <= -1 && CFLAG:CCOUNT:9 >= -99
			CFLAG:CCOUNT:9 = LOCAL:9 - 100
		ELSEIF CFLAG:CCOUNT:9 <= -100
			CFLAG:CCOUNT:9 = LOCAL:9 - 99
		ENDIF
		IF CFLAG:CCOUNT:230 <= -1 && CFLAG:CCOUNT:230 >= -99
			CFLAG:CCOUNT:230 = LOCAL:230 - 100
		ELSEIF CFLAG:CCOUNT:230 <= -100
			CFLAG:CCOUNT:230 = LOCAL:230 - 99
		ENDIF

		CALL SET_PARTYMEMBER
	NEXT
ENDIF
IF LASTLOAD_VERSION < 370 && LASTLOAD_VERSION != -1
	;制限日数を再計算
	IF FLAG:0 == 4
		FLAG:2 = 15
	ELSEIF FLAG:0 == 2
		FLAG:2 = 15
	ELSEIF FLAG:0 == 10
		FLAG:2 = 9
	ELSE
		FLAG:2 = 13
	ENDIF
	IF FLAG:0 != 2
		FLAG:2 -= MIN(CHARANUM - 4, 3)
		SIF FLAG:0 != 10
			FLAG:1 = (FLAG:3 * FLAG:2) + (FLAG:4 * 10)
	ENDIF
	;フラグの更新
	FLAG:804 = 0
	CALL RESEARCH_QUOTA
	;性耐性の調整を入れたのでステータスを再計算
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		CALL LEVELSTATUS, CCOUNT
	NEXT
ENDIF
IF LASTLOAD_VERSION < 372 && LASTLOAD_VERSION != -1
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		SIF NAME:CCOUNT == "博麗 霊夢" || NAME:CCOUNT == "霧雨 魔理沙" || NAME:CCOUNT == "東風谷 早苗"
			NO:CCOUNT += 1000
		SIF NAME:CCOUNT == "守崎 美紅" || NAME:CCOUNT == "ソフィー・アンドレア・雪籐" || NAME:CCOUNT == "菱堂 藍胡" || NAME:CCOUNT == "桜坂 ひかり" || NAME:CCOUNT == "茜島 蘭牙"
			NO:CCOUNT += 1000
		SIF NO:CCOUNT < 700
			CONTINUE
		SIF NAME:CCOUNT == "高町 なのは" || NAME:CCOUNT == "フェイト=テスタロッサ" || NAME:CCOUNT == "フェイト・T・ハラオウン" || NAME:CCOUNT == "八神 はやて" || NAME:CCOUNT == "高町 ヴィヴィオ" || NAME:CCOUNT == "アインハルト・ストラトス" || NAME:CCOUNT == "オリヴィエ・ゼーゲブレヒト" || NAME:CCOUNT == "ヴィクトーリア・ダールグリュン"
			NO:CCOUNT += 1000
		SIF NAME:CCOUNT == "島村卯月" || NAME:CCOUNT == "渋谷凛" || NAME:CCOUNT == "本田未央"
			NO:CCOUNT += 1000
	NEXT
ENDIF
IF LASTLOAD_VERSION < 373 && LASTLOAD_VERSION != -1
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		;ボス触手が父親の場合、ＩＤのズレを修正
		SIF CFLAG:CCOUNT:230 >= 100
			CFLAG:CCOUNT:230 += 1
		SIF CFLAG:CCOUNT:9 >= 100
			CFLAG:CCOUNT:9 += 1
	NEXT
ENDIF
IF LASTLOAD_VERSION < 380 && LASTLOAD_VERSION != -1
	;オミットされたフラグを初期化
	FLAG:19 = 0
	FLAG:851 = 0
	;コンフィグを初期設定に変更
	FLAG:800 = 0
	FLAG:801 = 1
	FLAG:802 = 31
	FLAG:803 = 7
	FLAG:804 = 7
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		;刻印防止を初期化
		MARK:CCOUNT:快楽刻印防止 = 0
		MARK:CCOUNT:苦痛刻印防止 = 0
		MARK:CCOUNT:屈服刻印防止 = 0
		MARK:CCOUNT:恐怖刻印防止 = 0
		MARK:CCOUNT:恥辱刻印防止 = 0
	NEXT
ENDIF
IF LASTLOAD_VERSION < 381 && LASTLOAD_VERSION != -1
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		;素質基本値を新仕様に合わせて変更
		SIF GETBIT(BASE:CCOUNT:48, 0)
			BASE:CCOUNT:体格基本値 = -1
		SIF GETBIT(BASE:CCOUNT:48, 1)
			BASE:CCOUNT:体格基本値 = 1
		SIF GETBIT(BASE:CCOUNT:48, 2)
			BASE:CCOUNT:胸サイズ基本値 = -1
		SIF GETBIT(BASE:CCOUNT:48, 3)
			BASE:CCOUNT:胸サイズ基本値 = 1
		SIF GETBIT(BASE:CCOUNT:48, 4)
			BASE:CCOUNT:性別基本値 = 1
		;オミットされたBASEを初期化
		BASE:CCOUNT:42 = 0
		MAXBASE:CCOUNT:42 = 0
		BASE:CCOUNT:48 = 0
		MAXBASE:CCOUNT:48 = 0
	NEXT
ENDIF
IF LASTLOAD_VERSION < 382 && LASTLOAD_VERSION != -1
	;相関関係の全探索
	CALL CHECK_ALL_RELATION
ENDIF
IF LASTLOAD_VERSION < 394 && LASTLOAD_VERSION != -1
	;目つきの追加
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE
		SIF CSTR:CCOUNT:18 == ""
			CSTR:CCOUNT:18 = 普通
	NEXT
ENDIF
IF LASTLOAD_VERSION < GAMEBASE_VERSION && LASTLOAD_VERSION != -1
	PRINTL 【セーブデータを最新バージョンにアップデートしました】
	LOCALS:0 = {1000 + LASTLOAD_VERSION}
	SUBSTRING LOCALS:0, 1, 3
	LOCALS:0 = {LASTLOAD_VERSION / 1000}.%RESULTS%
	LOCALS:1 = {1000 + GAMEBASE_VERSION}
	SUBSTRING LOCALS:1, 1, 3
	LOCALS:1 = {GAMEBASE_VERSION / 1000}.%RESULTS%
	PRINTFORMW 　ver %LOCALS:0% → %LOCALS:1%
	;０除算バグ用
	SIF LASTLOAD_VERSION < 190
		CALL ENDING
ENDIF
PRINTL 
;**********************************************


@SHOW_SHOP
#DIM CCOUNT
;人気度の上限下限を設定
FLAG:853 = LIMIT(FLAG:853, -100, 100)
DRAWLINE
;フラッシュニュース
CALL FLASHNEWS

;途中ロード用
FLAG:799 = 0

;生き残っているボスの数を見る
CALL TENTACLE_SURVIVE, "NUM"
LOCAL = RESULT

IF TIME == 0
	LOCALS = 昼
ELSEIF TIME == 1
	LOCALS = 夜
ENDIF

;**********************************************************
;ここからショップ画面表示部分

DRAWLINE
PRINTFORM インターミッション {DAY}日目 
IF TIME == 0
	SETCOLOR 230,100,0
ELSE
	SETCOLOR 0,30,230
ENDIF
PRINTFORM %LOCALS%
RESETCOLOR
;日数制限解除の効果
IF FLAG:906 > 0
	IF FLAG:0 == 0
		PRINTL 
	ELSE
		PRINTFORML （完全殲滅まで∞日）
	ENDIF
ELSEIF FLAG:10 == 0
	IF FLAG:0 == 0
		PRINTL 
	ELSEIF FLAG:0 == 10
		PRINTFORML （{FLAG:3 - LOCAL + 1}体目殲滅まで{(FLAG:3 - LOCAL + 1) * FLAG:2 - DAY + DAY:1}日/完全殲滅まで∞日）
	ELSE
		PRINTFORML （{FLAG:3 - LOCAL + 1}体目殲滅まで{(FLAG:3 - LOCAL + 1) * FLAG:2 - DAY + DAY:1}日/完全殲滅まで{FLAG:1 - DAY + DAY:1}日）
	ENDIF
ELSEIF FLAG:10 == 1
	IF FLAG:0 == 0
		PRINTL 
	ELSEIF FLAG:0 == 10
		PRINTFORML （完全殲滅まで∞日）
	ELSE
		PRINTFORML （完全殲滅まで{FLAG:1 - DAY + DAY:1}日）
	ENDIF
ENDIF
;資金
PRINTFORM 資金：{MONEY}＄　
;防衛力
IF FLAG:852 == 0
	SETCOLOR 120,0,0
ELSEIF FLAG:852 < 1250
	SETCOLOR 250,0,0
ELSEIF FLAG:852 < 2500
	SETCOLOR 250,250,100
ELSEIF FLAG:852 < 10000
	SETCOLOR 0,250,60
ELSEIF FLAG:852 < 20000
	SETCOLOR 0,200,255
ELSE
	SETCOLOR 200,0,255
ENDIF
PRINTFORM 防衛力：{FLAG:852}　　
;人気度
IF FLAG:853 <= -75
	SETCOLOR 180,0,0
ELSEIF FLAG:853 <= -50
	SETCOLOR 250,50,50
ELSEIF FLAG:853 < 0
	SETCOLOR 250,200,200
ELSEIF FLAG:853 < 50
	SETCOLOR 200,250,200
ELSEIF FLAG:853 < 75
	SETCOLOR 100,250,150
ELSE
	SETCOLOR 100,250,200
ENDIF
PRINTFORM 人気度：{FLAG:853}
PRINTL 
;探索状況
IF FLAG:47 >= FLAG:46
	SETCOLOR 255,125,125
ELSE
	SETCOLOR 255,180,0
ENDIF
PRINTFORM 探索状況：
IF FLAG:47 < FLAG:46
	PRINTFORM 探索度{PERCENT_CAL_F(FLAG:47, FLAG:46)}％ ({FLAG:47}/{FLAG:46})
ELSEIF FLAG:10 == 1
	PRINTFORM ラスボス触手を発見！
ELSE
	PRINTFORM ボス触手を発見！
ENDIF
IF FLAG:47 >= FLAG:46
	IF TIME == 0
		LOCAL:1 = 40
	ELSEIF TIME == 1
		LOCAL:1 = 50
	ENDIF
	IF FLAG:10 == 1
		LOCAL:1 += 50
	ELSE
		LOCAL:1 += FLAG:3 * 3
	ENDIF
	LOCAL:1 = LOCAL:1 * FLAG:47 / FLAG:46
	FOR LOCAL,0, CHARANUM
		SIF CONFIG_CHECK_BALANCE_F(1) > 0 && FLAG:18 > 0 && (CFLAG:LOCAL:100 == 101 || CFLAG:LOCAL:100 == 105)
			LOCAL:1 += 4
	NEXT
	SIF LOCAL:1 > 95
		LOCAL:1 = 95
	PRINTFORM (遭遇率 {LOCAL:1}％)　
	SETCOLOR 255,255,225
	IF CONFIG_CHECK_BALANCE_F(1) > 0 && FLAG:18 > 0
		PRINT 索敵対象：
		FLAG:11 = FLAG:18
		SAVESTR:13 = BOSS
		CALL TENTACLE_ACCESS, "GETNAME"
		PRINTFORM %RESULTS%
	ENDIF
ENDIF
RESETCOLOR
PRINTL 
;キャラのステータス
CALL SHOW_STATUS_BASE
PRINTPLAIN                                      
SIF CHARANUM_ALIVE_PARTYCHECK(0) == 0
	PRINTPLAIN                     
IF CHARANUM > 2 || CHARANUM_ALIVE_PARTYCHECK(0) || FLAG:63
	IF FLAG:63
		FONTBOLD
		SETCOLOR 250,180,50
	ENDIF
	PRINT [50] パーティ編成　
	SIF FLAG:63 == 0
		PRINTPLAIN  
	FONTREGULAR
	RESETCOLOR
ELSE
	PRINTPLAIN                
ENDIF
IF CHARANUM_ALIVE_PARTYCHECK(0) && FLAG:61
	PRINT     [60] ▲操作キャラのみ
ELSEIF CHARANUM_ALIVE_PARTYCHECK(0)
	PRINT         [60] ▼全表示
ENDIF
PRINTL 

;インフォメーション
PRINTL 【インフォメーション】
CALL SHOP_INFOMATION
PRINTL 

;各キャラの行動予定の表示
SIF FLAG:63 == 0
	CALL SHOP_ACTION_PLANDISP(0)

;一括設定用
IF FLAG:9 == 1
	LOCAL:1 = 1
	FONTBOLD
	SETCOLOR 255, 150, 0
ELSE
	SETCOLOR 120, 60, 0
ENDIF
SIF CHARANUM_ALIVE() >= 2 && FLAG:63 == 0
	PRINTFORM [90]一括設定
RESETCOLOR
FONTREGULAR
SIF FLAG:63 == 0
	PRINTL 
DRAWLINE
;地の文：ショップ画面での一口メッセージ呼び出し用
LOCAL = TARGET
LOCAL:1 = 0
IF FLAG:9 && CHARANUM_ACTIVE() > 0
	$HITOKUCHI_LOOP
	TARGET = RAND:(CHARANUM -1) + 1
	SIF CFLAG:TARGET:0 != 0 || CFLAG:TARGET:999 == 0
		GOTO HITOKUCHI_LOOP
ENDIF
SIF CFLAG:TARGET:0 == 0 && FLAG:63 == 0 && TARGET != MASTER
	CALL MESSAGE_HITOKUTI_SHOP
TARGET = LOCAL

IF FLAG:63 == 0
	PRINTL [100]行動開始
	PRINTL 
ELSE
	IF TARGET != 0
		PRINT 選択中のキャラ：
		SETCOLOR 250,180,50
		PRINTPLAINFORM [{TARGET}]%CALLNAME:TARGET%
		RESETCOLOR
		PRINTL 　⇒　
		PRINTL （位置を入れ替える対象のキャラを選択してください）
		PRINTL （選択中のキャラを再度選ぶと選択を解除します）
	ELSE
		PRINTFORML 選択中のキャラ：なし
		PRINTL （配置を変更するキャラを選択してください）
		PRINTL 
	ENDIF
	IF TARGET != 0
		IF CFLAG:TARGET:999 == 0 && CHARANUM_ACTIVE() < パーティ人数最大値
			PRINTL 
			IF CFLAG:TARGET:0 == 10
				PRINT 選択中のキャラは特別病棟に入院中のため、パーティに加えられません。
			ELSEIF CFLAG:TARGET:0 == 11
				PRINT 選択中のキャラは特別病棟に育児中のため、パーティに加えられません。
			ELSE
				PRINTL [100]選択中のキャラをパーティに加える
			ENDIF
		ELSEIF CFLAG:TARGET:999
			PRINTL 
			PRINTL [100]選択中のキャラをパーティから外す
		ENDIF
	ENDIF
ENDIF
IF FLAG:0 != 0 && FLAG:63 == 0
	SETCOLOR 255, 170, 170
	PRINTFORM [101]出撃する　　　 
	SETCOLOR 255, 255, 170
	PRINTFORM [102]鍛錬する　　　 
	SETCOLOR 170, 170, 255
	PRINTFORM [103]休憩する　　　 
	SETCOLOR 170, 255, 255
	PRINTFORM [104]特別活動　　　 
	PRINTL 

	IF FLAG:0 != 2
		SETCOLOR 255, 170, 255
		PRINTFORM [105]拠点防衛　　　 
	ELSE
		SETCOLOR 96,96,96
		PRINTPLAIN [105]拠点防衛　　　 
	ENDIF
	IF CHARANUM >= 3
		SETCOLOR 170, 255, 170
		PRINTFORM [106]戦闘支援　　　 
	ELSE
		SETCOLOR 96,96,96
		PRINTPLAIN [106]戦闘支援　　　 
	ENDIF
	SETCOLOR 255, 200, 50
	PRINTFORM [107]情報収集　　　 
	SETCOLOR 50, 200, 255
	PRINTFORM [108]自由行動
	PRINTL 
ENDIF
RESETCOLOR
PRINTL 
PRINT [110]ステータス表示 
IF FLAG:0 != 0 && FLAG:63 == 0
	PRINT [111]キャラの強化   
	PRINT [112]衣装の設定　　 
	PRINTL [113]メディカルルーム
	PRINTL [114]カスタマイズ 
	PRINT [120]衣装の購入　　 
ELSE
	PRINTL 
ENDIF
PRINT [130]状況の確認　　 
;SIF GETBIT(FLAG:###,11) && CHARANUM > 4
;	PRINT [140]引退する　　　 
IF FLAG:63 == 0 && FLAG:0 != 0
	PRINT [150]施設の拡張　　 
	PRINT [160]スケジュール設定
ENDIF
PRINTL 
PRINT [200]セーブ　　　　 
PRINT [300]ロード         
PRINT [700]コンフィグ　　 
PRINT [800]トロフィー確認 

;出撃可能チェック
@SORTIE_CHECK
#DIM CCOUNT
LOCAL = 0
FOR CCOUNT, 0, CHARANUM
	SIF CCOUNT == MASTER
		CONTINUE
	SIF (CFLAG:CCOUNT:100 == 101 && BASE:CCOUNT:体力 > 500) || (CFLAG:CCOUNT:100 == 105 && BASE:CCOUNT:体力 > 500)
		LOCAL += 1
NEXT
RETURN LOCAL

@USERSHOP
#DIM CCOUNT
IF RESULT == 100 && TARGET != 0 && FLAG:63 && CFLAG:TARGET:0 == 0
	IF CFLAG:TARGET:999 == 0 && CHARANUM_ACTIVE() < パーティ人数最大値
		CFLAG:TARGET:999 = 1
	ELSEIF CFLAG:TARGET:999
		CFLAG:TARGET:999 = 0
		SIF CHARANUM_ALIVE_PARTYCHECK(0)
			FLAG:61 = 1
	ENDIF
	TARGET = 0
ELSEIF RESULT == 100 && FLAG:63 == 0
	CALL SORTIE_CHECK
	IF FLAG:40 == 0 && FLAG:0 != 0
		DRAWLINE
		PRINTL 
		PRINTL 各キャラの行動予定は下のようです
		PRINTL 
		CALL SHOP_ACTION_PLANDISP(1)
		PRINTL 
		PRINTL この設定で行動を開始しますか？
		PRINTL ※ 行動を設定していないキャラは自動的に休憩になります
		CALL SORTIE_CHECK
		SIF RESULT == 0 && FLAG:0 != 2
			PRINTL ※ 出撃または防衛しないことにより防衛力が低下します
		DRAWLINE
		PRINTL [0]いいえ
		PRINTL [1]はい
		PRINTL [9]はい（次から確認しない）
		$INPUT_LOOP
		INPUT
		IF RESULT == 9
			FLAG:40 = 1
			CALL SHOP_ACTION
		ELSEIF RESULT < 0 || RESULT > 9
		ELSEIF RESULT == 0
		ELSEIF RESULT == 1
			CALL SHOP_ACTION
		ENDIF
	;出撃もしくは防衛できるキャラがいない
	ELSEIF FLAG:40 == 1 && RESULT == 0 && FLAG:0 != 2 && FLAG:0 != 0
		DRAWLINE
		PRINTL 
		PRINTL 出撃・防衛を行う予定のキャラが一人も居ません
		PRINTL 
		CALL SHOP_ACTION_PLANDISP(1)
		PRINTL 
		PRINTL このまま行動を開始して宜しいですか？
		PRINTL ※ 出撃または防衛しないことにより防衛力が低下します
		DRAWLINE
		PRINTL [0]いいえ
		PRINTL [1]はい
		PRINTL [9]はい（次から確認しない）
		$INPUT_LOOP_1
		INPUT
		IF RESULT == 9
			FLAG:40 = 2
			CALL SHOP_ACTION
		ELSEIF RESULT < 0 || RESULT > 9
		ELSEIF RESULT == 0
		ELSEIF RESULT == 1
			CALL SHOP_ACTION
		ENDIF
	ELSE
		CALL SHOP_ACTION
	ENDIF
ELSEIF RESULT == 101 && FLAG:0 != 0 && TARGET != MASTER && (CFLAG:0 == 0 || FLAG:9) && FLAG:63 == 0
	IF FLAG:9 == 0
		PRINTL 
		;妊娠中は出撃できない
		IF CHECK_PREGNANT_F(TARGET)
			PRINTL 妊娠中は出撃できません
			PRINTL
		;FEAT効果によるコマンド制限
		ELSEIF TALENT:夜魔の貴族 > 0 && TIME == 0
			SETCOLOR 255,128,0
			PRINTFORML %CALLNAME%は[夜魔の貴族]の効果で昼間は外出できません！
			RESETCOLOR
			PRINTL 
		ELSE
			CFLAG:100 = 101
			PRINTFORML %CALLNAME%は出撃することにしました
		ENDIF
	ELSE
		FOR CCOUNT, 0, CHARANUM
			SIF CCOUNT == MASTER
				CONTINUE
			SIF CFLAG:CCOUNT:999 == 0
				CONTINUE
			SIF CFLAG:CCOUNT:0 == 1 || CFLAG:CCOUNT:0 == 2 || CFLAG:CCOUNT:0 == 3 || CFLAG:CCOUNT:0 == 9
				CONTINUE
			PRINTL 
			;妊娠中は出撃できない
			IF CHECK_PREGNANT_F(CCOUNT) > 0
				PRINTFORML %CALLNAME:CCOUNT%は妊娠中のため出撃できません
			;FEAT効果によるコマンド制限
			ELSEIF TALENT:CCOUNT:夜魔の貴族 > 0 && TIME == 0
				SETCOLOR 255,128,0
				PRINTFORML %CALLNAME:CCOUNT%は[夜魔の貴族]の効果で外出は出撃できません！
				RESETCOLOR
			ELSE
				CFLAG:CCOUNT:100 = 101
				PRINTFORML %CALLNAME:CCOUNT%は出撃することにしました
			ENDIF
		NEXT
	ENDIF
	PRINTW 
ELSEIF RESULT == 102 && FLAG:0 != 0 && TARGET != MASTER && (CFLAG:0 == 0 || FLAG:9) && FLAG:63 == 0
	IF FLAG:9 == 0
		PRINTL 
		CFLAG:100 = 102
		PRINTFORML %CALLNAME%は鍛錬をすることにしました
	ELSE
		FOR CCOUNT, 0, CHARANUM
			SIF CCOUNT == MASTER
				CONTINUE
			SIF CFLAG:CCOUNT:999 == 0
				CONTINUE
			SIF CFLAG:CCOUNT:0 == 1 || CFLAG:CCOUNT:0 == 2 || CFLAG:CCOUNT:0 == 3 || CFLAG:CCOUNT:0 == 9
				CONTINUE
			PRINTL 
			CFLAG:CCOUNT:100 = 102
			PRINTFORML %CALLNAME:CCOUNT%は鍛錬をすることにしました
		NEXT
	ENDIF
	PRINTW 
ELSEIF RESULT == 103 && FLAG:0 != 0 && TARGET != MASTER && (CFLAG:0 == 0 || FLAG:9) && FLAG:63 == 0
	IF FLAG:9 == 0
		PRINTL 
		CFLAG:100 = 103
		PRINTFORML %CALLNAME%は休憩することにしました
	ELSE
		FOR CCOUNT, 0, CHARANUM
			SIF CCOUNT == MASTER
				CONTINUE
			SIF CFLAG:CCOUNT:999 == 0
				CONTINUE
			SIF CFLAG:CCOUNT:0 == 1 || CFLAG:CCOUNT:0 == 2 || CFLAG:CCOUNT:0 == 3 || CFLAG:CCOUNT:0 == 9
				CONTINUE
			PRINTL 
			CFLAG:CCOUNT:100 = 103
			PRINTFORML %CALLNAME:CCOUNT%は休憩することにしました
		NEXT
	ENDIF
	PRINTW 
ELSEIF RESULT == 104 && FLAG:0 != 0 && TARGET != MASTER && (CFLAG:0 == 0 || FLAG:9) && FLAG:63 == 0
	IF FLAG:9 == 0
		;FEAT効果によるコマンド制限
		IF TALENT:夜魔の貴族 > 0 && TIME == 0
			SETCOLOR 255,128,0
			PRINTFORML %CALLNAME%は[夜魔の貴族]の効果で昼間は外出できません！
			RESETCOLOR
			PRINTL 
		ELSEIF TALENT:生粋の戦士 > 0
			SETCOLOR 255,128,0
			PRINTFORML %CALLNAME%は[生粋の戦士]の効果で特別活動に参加できません！
			RESETCOLOR
			PRINTL 
		ELSE
			PRINTL 
			CFLAG:100 = 104
			PRINTFORML %CALLNAME%は資金を稼ぐことにしました
		ENDIF
	ELSE
		FOR CCOUNT, 0, CHARANUM
			SIF CCOUNT == MASTER
				CONTINUE
			SIF CFLAG:CCOUNT:999 == 0
				CONTINUE
			SIF CFLAG:CCOUNT:0 == 1 || CFLAG:CCOUNT:0 == 2 || CFLAG:CCOUNT:0 == 3 || CFLAG:CCOUNT:0 == 9
				CONTINUE
			PRINTL 
			;FEAT効果によるコマンド制限
			IF TALENT:CCOUNT:夜魔の貴族 > 0 && TIME == 0
				SETCOLOR 255,128,0
				PRINTFORML %CALLNAME:CCOUNT%は[夜魔の貴族]の効果で昼間は外出できません！
				RESETCOLOR
			ELSEIF TALENT:CCOUNT:生粋の戦士 > 0
				SETCOLOR 255,128,0
				PRINTFORML %CALLNAME:CCOUNT%は[生粋の戦士]の効果で特別活動に参加できません！
				RESETCOLOR
			ELSE
				CFLAG:CCOUNT:100 = 104
				PRINTFORML %CALLNAME:CCOUNT%は資金を稼ぐことにしました
			ENDIF
		NEXT
	ENDIF
	PRINTW 
ELSEIF RESULT == 105 && FLAG:0 != 2 && FLAG:0 != 0 && TARGET != MASTER && (CFLAG:0 == 0 || FLAG:9) && FLAG:63 == 0
	IF FLAG:9 == 0
		PRINTL 
		;妊娠中は出撃できない
		IF CHECK_PREGNANT_F(TARGET) > 0
			PRINTL 妊娠中は防衛に参加できません
			PRINTL
		;FEAT効果によるコマンド制限
		ELSEIF TALENT:夜魔の貴族 > 0 && TIME == 0
			SETCOLOR 255,128,0
			PRINTFORML %CALLNAME%は[夜魔の貴族]の効果で昼間は外出できません！
			RESETCOLOR
			PRINTL 
		ELSE
			PRINTFORML %CALLNAME%は拠点を防衛することにしました
			CFLAG:100 = 105
		ENDIF
	ELSE
		FOR CCOUNT, 0, CHARANUM
			SIF CCOUNT == MASTER
				CONTINUE
			SIF CFLAG:CCOUNT:999 == 0
				CONTINUE
			SIF CFLAG:CCOUNT:0 == 1 || CFLAG:CCOUNT:0 == 2 || CFLAG:CCOUNT:0 == 3 || CFLAG:CCOUNT:0 == 9
				CONTINUE
			PRINTL 
			;妊娠中は出撃できない
			IF CHECK_PREGNANT_F(CCOUNT) > 0
				PRINTFORML %CALLNAME:CCOUNT%は妊娠中のため防衛に参加できません
			;FEAT効果によるコマンド制限
			ELSEIF TALENT:CCOUNT:夜魔の貴族 > 0 && TIME == 0
				SETCOLOR 255,128,0
				PRINTFORML %CALLNAME:CCOUNT%は[夜魔の貴族]の効果で昼間は外出できません！
				RESETCOLOR
			ELSE
				CFLAG:CCOUNT:100 = 105
				PRINTFORML %CALLNAME:CCOUNT%は拠点を防衛することにしました
			ENDIF
		NEXT
	ENDIF
	PRINTW 
ELSEIF RESULT == 106 && CHARANUM >= 3 && FLAG:0 != 0 && TARGET != MASTER && (CFLAG:0 == 0 || FLAG:9) && FLAG:63 == 0
	IF FLAG:9 == 0
		IF TALENT:生粋の戦士 > 0
			SETCOLOR 255,128,0
			PRINTFORML %CALLNAME%は[生粋の戦士]の効果で戦闘支援に参加できません！
			RESETCOLOR
			PRINTL 
		ELSE
			PRINTL 
			CFLAG:100 = 106
			PRINTFORML %CALLNAME%は後方で戦闘支援に徹します
		ENDIF
	ELSE
		FOR CCOUNT, 0, CHARANUM
			SIF CCOUNT == MASTER
				CONTINUE
			SIF CFLAG:CCOUNT:999 == 0
				CONTINUE
			SIF CFLAG:CCOUNT:0 == 1 || CFLAG:CCOUNT:0 == 2 || CFLAG:CCOUNT:0 == 3 || CFLAG:CCOUNT:0 == 9
				CONTINUE
			PRINTL 
			IF TALENT:CCOUNT:生粋の戦士 > 0
				SETCOLOR 255,128,0
				PRINTFORML %CALLNAME:CCOUNT%は[生粋の戦士]の効果で戦闘支援に参加できません！
				RESETCOLOR
			ELSE
				CFLAG:CCOUNT:100 = 106
				PRINTFORML %CALLNAME:CCOUNT%は後方で戦闘支援に徹します
			ENDIF
		NEXT
	ENDIF
	PRINTW 
ELSEIF RESULT == 107 && FLAG:0 != 0 && TARGET != MASTER && (CFLAG:0 == 0 || FLAG:9) && FLAG:63 == 0
	IF FLAG:9 == 0
		;FEAT効果によるコマンド制限
		IF TALENT:夜魔の貴族 > 0 && TIME == 0
			SETCOLOR 255,128,0
			PRINTFORML %CALLNAME%は[夜魔の貴族]の効果で昼間は外出できません！
			RESETCOLOR
			PRINTL 
		ELSE
			PRINTL 
			CFLAG:100 = 107
			PRINTFORML %CALLNAME%は後方で情報収集に徹します
		ENDIF
	ELSE
		FOR CCOUNT, 0, CHARANUM
			SIF CCOUNT == MASTER
				CONTINUE
			SIF CFLAG:CCOUNT:999 == 0
				CONTINUE
			SIF CFLAG:CCOUNT:0 == 1 || CFLAG:CCOUNT:0 == 2 || CFLAG:CCOUNT:0 == 3 || CFLAG:CCOUNT:0 == 9
				CONTINUE
			PRINTL 
			;FEAT効果によるコマンド制限
			IF TALENT:CCOUNT:夜魔の貴族 > 0 && TIME == 0
				SETCOLOR 255,128,0
				PRINTFORML %CALLNAME:CCOUNT%は[夜魔の貴族]の効果で昼間は外出できません！
				RESETCOLOR
			ELSE
				CFLAG:CCOUNT:100 = 107
				PRINTFORML %CALLNAME:CCOUNT%は後方で情報収集に徹します
			ENDIF
		NEXT
	ENDIF
	PRINTW 
ELSEIF RESULT == 108 && FLAG:0 != 0 && TARGET != MASTER && (CFLAG:0 == 0 || FLAG:9) && FLAG:63 == 0
	IF FLAG:9 == 0
		;FEAT効果によるコマンド制限
		IF TALENT:夜魔の貴族 > 0 && TIME == 0
			SETCOLOR 255,128,0
			PRINTFORML %CALLNAME%は[夜魔の貴族]の効果で昼間は外出できません！
			RESETCOLOR
			PRINTL 
		ELSE
			PRINTL 
			CFLAG:100 = 108
			PRINTFORML %CALLNAME%は自由に行動することにしました
		ENDIF
	ELSE
		FOR CCOUNT, 0, CHARANUM
			SIF CCOUNT == MASTER
				CONTINUE
			SIF CFLAG:CCOUNT:999 == 0
				CONTINUE
			SIF CFLAG:CCOUNT:0 == 1 || CFLAG:CCOUNT:0 == 2 || CFLAG:CCOUNT:0 == 3 || CFLAG:CCOUNT:0 == 9
				CONTINUE
			PRINTL 
			;FEAT効果によるコマンド制限
			IF TALENT:CCOUNT:夜魔の貴族 > 0 && TIME == 0
				SETCOLOR 255,128,0
				PRINTFORML %CALLNAME:CCOUNT%は[夜魔の貴族]の効果で昼間は外出できません！
				RESETCOLOR
			ELSE
				CFLAG:CCOUNT:100 = 108
				PRINTFORML %CALLNAME:CCOUNT%は自由に行動することにしました
			ENDIF
		NEXT
	ENDIF
	PRINTW 
ELSEIF RESULT == 110
	IF CHARANUM >= 3
		WHILE RESULT != 999
			PRINTL 
			PRINTL 【ステータス表示】
			CALL CHARA_LIST, 2,1
			SIF RESULT != 999
				CALL SHOW_STATUS_CHARA_SELECT, RESULT
		WEND
	ELSE
		PRINTL 
		PRINTL 【ステータス表示】
		TARGET = 1
		CALL SHOW_STATUS_CHARA_SELECT, TARGET
	ENDIF
	SIF FLAG:63
		TARGET = 0
ELSEIF RESULT == 111 && FLAG:0 != 0 && CHARANUM_ACTIVE() && FLAG:63 == 0
	IF CHARANUM >= 3
		WHILE RESULT != 999
			PRINTL 
			PRINTL 【キャラの強化】
			CALL CHARA_LIST, 1,2
			SIF RESULT != 999
				CALL CHARA_POWERUP, RESULT
		WEND
	ELSE
		PRINTL 
		PRINTL 【キャラの強化】
		TARGET = 1
		CALL CHARA_POWERUP, TARGET
	ENDIF
ELSEIF RESULT == 112 && FLAG:0 != 0 && CHARANUM_ACTIVE() && FLAG:63 == 0
	CALL CLOTH_WEAR
ELSEIF RESULT == 113 && FLAG:0 != 0 && FLAG:63 == 0 && FLAG:63 == 0
	CALL DRUG_PREPARATION
ELSEIF RESULT == 114 && FLAG:0 != 0 && FLAG:63 == 0 && FLAG:63 == 0
	IF CHARANUM >= 3
		WHILE RESULT != 999
			PRINTL 
			PRINTL 【武器カスタマイズ】
			CALL CHARA_LIST, 1,0
			SIF RESULT != 999
				CALL WEAPON_CUSTOMIZE, RESULT
		WEND
	ELSE
		PRINTL 
		PRINTL 【武器カスタマイズ】
		TARGET = 1
		CALL WEAPON_CUSTOMIZE, TARGET
	ENDIF
ELSEIF RESULT == 120 && FLAG:0 != 0 && FLAG:63 == 0 && FLAG:63 == 0
	CALL SHOW_SHOP_CLOTH
ELSEIF RESULT == 130 && FLAG:63 == 0
	CALL SHOW_STATUS_SENMETU
;ELSEIF RESULT == 140 && GETBIT(FLAG:###,11) && CHARANUM > パーティ人数最大値 && FLAG:63 == 0
;	CALL CHARA_INTAI
ELSEIF RESULT == 150 && FLAG:0 != 0 && FLAG:63 == 0
	CALL HOME_ENHANCING
ELSEIF RESULT == 160 && FLAG:63 == 0
	IF CFLAG:0 != 0 || TARGET == MASTER || FLAG:9
		PRINTW スケジュールを設定するキャラクターが選択されていません
	ELSE
		CALL SCHEDULE
	ENDIF
ELSEIF RESULT == 200
	FIRSTLINE = LINECOUNT
	CALL SAVEGAME_PAGE
ELSEIF RESULT == 300
	FIRSTLINE = LINECOUNT
	CALL LOADGAME_PAGE
ELSEIF RESULT == 400
	;名前変更やキャラソート用に空けてる
	;DEBUG
	IF FLAG:999 == 0
		PRINTL 
		PRINTL 
		PRINTL DEBUG ON
		FLAG:999 = 1
		SETBGCOLOR 0,0,40
	ELSEIF FLAG:999 == 1
		PRINTL 
		PRINTL 
		PRINTL DEBUG OFF
		FLAG:999 = 0
		RESETBGCOLOR
	ENDIF
ELSEIF RESULT == 700
	CALL CONFIG
ELSEIF RESULT == 800
	CALL SHOW_TROPHY
ELSEIF RESULT == 90 && CHARANUM_ALIVE() >= 2 && FLAG:63 == 0
	SIF TARGET == MASTER
		TARGET = RAND:(CHARANUM-1) + 1
	IF FLAG:9 == 0
		PRINTL 一括設定モードに変更しました
		FLAG:9 = 1
	ENDIF
ELSEIF RESULT == 50 && (CHARANUM > 2 || CHARANUM_ALIVE_PARTYCHECK(0) || FLAG:63)
	IF FLAG:63
		PRINTL 編成モードを解除します
		FLAG:63 = 0
		FLAG:61 = 0
	ELSE
		CALL SET_PARTYMEMBER
		PRINTL 編成モードに移行します
		FLAG:63 = 1
		SIF CHARANUM_ALIVE_PARTYCHECK(0)
			FLAG:61 = 1
		FLAG:9 = 0
		FOR CCOUNT, 0, CHARANUM
			CFLAG:CCOUNT:100 = 0
		NEXT
		CALL SET_PARTYMEMBER
		TARGET = 0
	ENDIF
ELSEIF RESULT == 60 && CHARANUM_ALIVE_PARTYCHECK(0)
	IF FLAG:61
		PRINTL キャラを全員表示します
		FLAG:61 = 0
	ELSE
		PRINTL パーティのみ表示します
		FLAG:61 = 1
	ENDIF
ELSEIF RESULT >= 1 && RESULT <= CHARANUM -1 && CFLAG:RESULT:999 != 0 && FLAG:63 == 0
	FLAG:9 = 0
	IF CHARANUM > RESULT
		IF CFLAG:RESULT:0 == 0
			TARGET = RESULT
			PRINTL 
			PRINTFORML 操作キャラを%CALLNAME%に変更しました
			PRINTL 
		ENDIF
	ENDIF
ELSEIF RESULT >= 1 && RESULT <= CHARANUM -1 && FLAG:63
	IF CFLAG:RESULT:0 == 1 || CFLAG:RESULT:0 == 2 || CFLAG:RESULT:0 == 3 || CFLAG:RESULT:0 == 4 || CFLAG:RESULT:0 == 9
	ELSEIF TARGET == 0
		TARGET = RESULT
	ELSEIF TARGET == RESULT
		TARGET = 0
	ELSEIF CFLAG:TARGET:0 == 10
		PRINTFORML %CALLNAME:TARGET%は特別病棟に入院中のため、入れ替えられません。
		PRINTW 
		TARGET = 0
	ELSEIF CFLAG:TARGET:0 == 11
		PRINTFORML %CALLNAME:TARGET%は育児中のため、入れ替えられません。
		PRINTW 
		TARGET = 0
	ELSEIF CFLAG:RESULT:0 == 10
		PRINTFORML %CALLNAME:RESULT%は特別病棟に入院中のため、入れ替えられません。
		PRINTW 
		TARGET = 0
	ELSEIF CFLAG:RESULT:0 == 11
		PRINTFORML %CALLNAME:RESULT%は育児中のため、入れ替えられません。
		PRINTW 
		TARGET = 0
	ELSE
		;キャラを入れ替える
		SETCOLOR 250,180,50
		PRINTFORM 　[{TARGET}]%CALLNAME:TARGET%
		RESETCOLOR
		PRINT と
		SETCOLOR 250,180,50
		PRINTFORM [{RESULT}]%CALLNAME:RESULT%
		RESETCOLOR
		PRINTL の配置を入れ替えた！
		PRINTW 
		;RELATION
		FOR LOCAL, 0, CHARANUM
			SIF LOCAL == MASTER
				CONTINUE
			SWAP RELATION:LOCAL:TARGET, RELATION:LOCAL:RESULT
		NEXT
		SWAP CFLAG:TARGET:999, CFLAG:RESULT:999
		SWAPCHARA TARGET,RESULT
		TARGET = 0
	ENDIF
ELSE
ENDIF


;--------------------------------------------------
;状況の表示
@SHOW_STATUS_SENMETU
#DIM CCOUNT

LOCAL = 0
LOCAL:1 = 1
;触手の殲滅状況
PRINTL 

LOCAL = FLAG:11
IF FLAG:10 == 0
	PRINTFORML 現在活動中の%STR:2502%
	SAVESTR:13 = BOSS
	DRAWLINE
	REPEAT FLAG:3
		CALL TENTACLE_SURVIVE_CHECK, LOCAL:1
		IF RESULT > 0
			FLAG:11 = RESULT
			PRINT [
			CALL TENTACLE_ACCESS, "NAME"
			PRINT ]
		ENDIF
		LOCAL:1 *=2
	REND
ELSEIF FLAG:10 == 1
	PRINTFORML 現在活動中の%STR:2503%
	DRAWLINE
	REPEAT FLAG:4
		CALL TENTACLE_SURVIVE_CHECK, LOCAL:1
		IF RESULT > 0
			FLAG:11 = RESULT
			PRINT [
			CALL TENTACLE_ACCESS, "NAME"
			PRINT ]
		ENDIF
		LOCAL:1 *=2
	REND
ENDIF
FLAG:11 = LOCAL
PRINTL 
DRAWLINE
PRINTW 

;入院/育児中のキャラの確認
LOCAL = 0
FOR CCOUNT, 0, CHARANUM
	SIF CCOUNT == MASTER
		CONTINUE
	SIF CFLAG:CCOUNT:0 == 10 || CFLAG:CCOUNT:0 == 11
		LOCAL ++
NEXT
IF LOCAL
	PRINTFORML 入院/育児中のキャラ
	DRAWLINE
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE

		IF CFLAG:CCOUNT:0 == 10
			PRINTFORM  %CALLNAME:CCOUNT%：特別病棟に入院　
		ELSEIF CFLAG:CCOUNT:0 == 11
			PRINTFORM  %CALLNAME:CCOUNT%：育児中　
		ENDIF
		;妊娠状態
		SIF (CHECK_PREGNANT_F(CCOUNT) > 0 && CFLAG:CCOUNT:0 == 10) || (CHECK_PREGNANT_F(CCOUNT) > 0 && CFLAG:CCOUNT:0 == 11)
			PRINT [妊娠中]
		SIF CFLAG:CCOUNT:0 == 10 || CFLAG:CCOUNT:0 == 11
			PRINTL 
	NEXT
	DRAWLINE
	PRINTW 
ENDIF

;幽閉中のキャラの確認
PRINTFORML 幽閉中のキャラ
DRAWLINE
LOCAL = 0
FOR CCOUNT, 0, CHARANUM
	SIF CCOUNT == MASTER
		CONTINUE
	
	IF CFLAG:CCOUNT:0 == 1
		;幽閉日数の計算
		LOCAL:1 = 0
		SIF CFLAG:CCOUNT:31 > 0
			LOCAL:1 = CFLAG:CCOUNT:31 / 2
		
		PRINTFORM  %CALLNAME:CCOUNT%：
		IF (CFLAG:CCOUNT:20 == 2)
			FOR LOCAL:2, 0, CHARANUM
				RESULT = 0
				SIF CFLAG:CCOUNT:21 == CFLAG:(LOCAL:2):240
					RESULT = LOCAL:2
				SIF RESULT
					BREAK
			NEXT
			PRINTFORM %PRINT_TRANSCALLNAME(RESULT)%
		ELSE
			CALL TENTACLE_ACCESS_PRISON, CCOUNT, "NAME"
		ENDIF
		PRINTFORM によって幽閉中 {CFLAG:CCOUNT:31 / 2}日目　
		;妊娠状態
		SIF CHECK_PREGNANT_F(CCOUNT) > 0
			PRINT [妊娠中]　
		SIF CFLAG:CCOUNT:220 && CONFIG_CHECK_OTHER_F(0) == 0
			PRINTFORM 育児中の子触手：{CFLAG:CCOUNT:220}
		PRINTL 
		LOCAL += 1
	ENDIF
NEXT
SIF LOCAL == 0
	PRINTL なし
DRAWLINE
PRINTW 

;誘拐監禁中のキャラの確認
PRINTFORML 監禁中のキャラ
DRAWLINE
LOCAL = 0
FOR CCOUNT, 0, CHARANUM
	SIF CCOUNT == MASTER
		CONTINUE
	
	IF CFLAG:CCOUNT:0 == 4
		;監禁日数の計算
		LOCAL:1 = 0
		PRINTFORM  %CALLNAME:CCOUNT%：
		PRINTFORM クズ市民によって拉致監禁中 {CFLAG:CCOUNT:70 / 2}日目　
		;妊娠状態
		SIF CHECK_PREGNANT_F(CCOUNT) > 0
			PRINT [妊娠中]　
		SIF CFLAG:CCOUNT:219 && CONFIG_CHECK_OTHER_F(0) == 0
			PRINTFORM 育児中の子供：{CFLAG:CCOUNT:219}
		PRINTL 
		LOCAL += 1
	ENDIF
NEXT
SIF LOCAL == 0
	PRINTL なし
DRAWLINE
PRINTW 

;洗脳/悪堕ち中のキャラの確認
PRINTFORML 洗脳/悪堕ち中のキャラ
DRAWLINE
LOCAL = 0
FOR CCOUNT, 0, CHARANUM
	SIF CCOUNT == MASTER
		CONTINUE
	
	IF CFLAG:CCOUNT:0 == 2
		PRINTFORM  %CALLNAME:CCOUNT%：洗脳（
		IF CFLAG:CCOUNT:20 < 2
			CALL TENTACLE_ACCESS_PRISON, CCOUNT, "NAME"
		ELSEIF CFLAG:CCOUNT:20 == 2
			PRINTFORM %PRINT_TRANSCALLNAME(CFLAG:CCOUNT:21)%
		ENDIF
		PRINT ）　
	ELSEIF CFLAG:CCOUNT:0 == 3
		PRINTFORM  %CALLNAME:CCOUNT%：悪堕ち　
	ENDIF
	;妊娠状態
	SIF (CHECK_PREGNANT_F(CCOUNT) > 0 && CFLAG:CCOUNT:0 == 2) || (CHECK_PREGNANT_F(CCOUNT) > 0 && CFLAG:CCOUNT:0 == 3)
		PRINT [妊娠中]
	IF CFLAG:CCOUNT:0 == 2 || CFLAG:CCOUNT:0 == 3
		PRINTL 
		LOCAL += 1
	ENDIF
NEXT
SIF LOCAL == 0
	PRINTL なし
DRAWLINE
PRINTW 

;取り込まれたキャラ
IF FLAG:0 != 2
	PRINTFORML 取り込まれたキャラ
	DRAWLINE
	LOCAL = 0
	FOR CCOUNT, 0, CHARANUM
		SIF CCOUNT == MASTER
			CONTINUE

		SIF CFLAG:CCOUNT:0 == 9
			PRINTFORM  %CALLNAME:CCOUNT%：
		;苗床化状態
		IF TALENT:CCOUNT:苗床化 && CFLAG:CCOUNT:0 == 9
			PRINT 苗床化
		ELSEIF CFLAG:CCOUNT:0 == 9
			PRINT 取り込まれ
		ENDIF
		IF CFLAG:CCOUNT:0 == 9
			PRINTL 
			LOCAL += 1
		ENDIF
	NEXT
	SIF LOCAL == 0
		PRINTL なし
	DRAWLINE
	PRINTW 
ENDIF

;子触手の数
LOCAL = FLAG:44
FOR CCOUNT,0,CHARANUM
	LOCAL -= CFLAG:CCOUNT:220
NEXT
IF LOCAL
	PRINTFORML 活動中の子触手の総数
	DRAWLINE
	PRINTFORML  {LOCAL}匹
	DRAWLINE
	PRINTW 
ENDIF

;--------------------------------------------------
;施設拡張
@HOME_ENHANCING
PRINTL 

$INPUT_LOOP
IF FLAG:53 != 0
	PRINTFORML 購入済みのリラクゼーション設備
	DRAWLINE
	SIF (FLAG:53 & 観葉植物)
		PRINTFORML 　観葉植物　　　　　　常に疲労度を微量回復
	SIF (FLAG:53 & 心休まる風景画)
		PRINTFORML 　心休まる風景画　　　常に疲労度を微量回復
	SIF (FLAG:53 & オシャレなオブジェ)
		PRINTFORML 　オシャレなオブジェ　常に疲労度を微量回復 
	SIF (FLAG:53 & ゴージャスな噴水)
		PRINTFORML 　ゴージャスな噴水　　常に疲労度を微量回復
	SIF (FLAG:53 & 上質なベッド) && (FLAG:53 & 最高級ベッド) == 0
		PRINTFORML 　上質なベッド　　　　夜間休憩の疲労回復量がアップ  
	SIF (FLAG:53 & 最高級ベッド)
		PRINTFORML 　最高級ベッド　　　　夜間休憩の疲労回復量が大アップ
	SIF (FLAG:53 & マッサージチェア)
		PRINTFORML 　マッサージチェア　　常に疲労度を小回復
	SIF (FLAG:53 & シャワー設備)
		PRINTFORML 　シャワー設備　　　　鍛錬後に疲労度を小回復
	SIF (FLAG:53 & ゲームコーナー)
		PRINTFORML 　ゲームコーナー　　　昼間休憩の疲労回復量がアップ
	SIF (FLAG:53 & 大浴場) && (FLAG:53 & 美容温泉) == 0
		PRINTFORML 　大浴場　　　　　　　休憩時の疲労回復量がアップ
	SIF (FLAG:53 & 美容温泉)
		PRINTFORML 　美容温泉　　　　　　休憩時の疲労回復量が大アップ
	SIF (FLAG:53 & ビューティサロン)
		PRINTFORML 　ビューティサロン　　休憩時の疲労回復量が超アップ
	SIF (FLAG:54)
		PRINTFORML 　芸能オフィス　　　　デビュー済のメンバーの魅了経験毎日自動アップ
ELSE
	PRINTL 何をしますか？
ENDIF
IF FLAG:30 > 0 && FLAG:854 > 0
CALL GET_DAILYFEE
DRAWLINE
PRINTFORML   維持費明細：
PRINTFORML 　  設備維持 {維持費:1}＄　（鍛錬施設{100 + 500 * POWER(FLAG:50,2)}＄　休憩施設{100 + 100 * POWER(FLAG:51,2)}＄　防衛施設{100 + 500 * POWER(FLAG:52,2)}＄）
PRINTFORML 　  水道と電力 {維持費:2}＄
PRINTFORML 　  食費 {100 + 100 * CHARANUM_ALIVE()}
ENDIF
DRAWLINE
PRINTFORML [0]鍛錬設備のレベルアップ：現在の設備レベル：Lv.{FLAG:50}
PRINTFORML [1]休憩設備のレベルアップ：現在の設備レベル：Lv.{FLAG:51}
PRINTFORML [2]防衛設備のレベルアップ：現在の設備レベル：Lv.{FLAG:52}
PRINTFORML [3]リラクゼーション施設の追加
IF FLAG:54
PRINTFORML [4]芸能オフィスに施設追加（未実装）
ELSE
PRINTFORML [4]芸能オフィスを設置する (必要資金：100000)
ENDIF

PRINTL [999]戻る
INPUT
IF RESULT == 999
ELSEIF RESULT == 0
	IF FLAG:50 >= 5
		PRINTL これ以上設備レベルは上げられません
		GOTO INPUT_LOOP
	ELSE
		PRINTL 
		PRINTFORML 設備のレベルアップには{5000 * FLAG:50 + 5000}＄必要です
		PRINTL 設備のレベルアップを行いますか？
		
		PRINTL [0]はい
		PRINTL [1]いいえ
		$INPUT_LOOP_SELECT
		INPUT
		IF RESULT == 0
			IF MONEY < 5000 * FLAG:50 + 5000
				PRINTL 所持資金が足りません
				PRINTW 
				GOTO INPUT_LOOP
			ELSE
				MONEY -= 5000 * FLAG:50 + 5000
				FLAG:50 += 1
				PRINTL 設備レベルが上がりました！
				PRINTW 
			ENDIF
		ELSEIF RESULT == 1
		ELSE
			PRINTL 
			PRINTL 正しい値を入力してください
			GOTO INPUT_LOOP_SELECT
		ENDIF
	ENDIF
ELSEIF RESULT == 1
	IF FLAG:51 >= 5
		PRINTL これ以上設備レベルは上げられません
		GOTO INPUT_LOOP
	ELSE
		PRINTL 
		PRINTFORML 設備のレベルアップには{1000 * FLAG:51 + 1000}＄必要です
		PRINTL 設備のレベルアップを行いますか？
		
		PRINTL [0]はい
		PRINTL [1]いいえ
		$INPUT_LOOP_SELECT_1
		INPUT
		IF RESULT == 0
			IF MONEY < 1000 * FLAG:51 + 1000
				PRINTL 所持資金が足りません
				PRINTW 
				GOTO INPUT_LOOP
			ELSE
				MONEY -= 1000 * FLAG:51 + 1000
				FLAG:51 += 1
				PRINTL 設備レベルが上がりました！
				PRINTW 
			ENDIF
		ELSEIF RESULT == 1
		ELSE
			PRINTL 
			PRINTL 正しい値を入力してください
			GOTO INPUT_LOOP_SELECT_1
		ENDIF
	ENDIF
ELSEIF RESULT == 2
	IF FLAG:52 >= 5
		PRINTL これ以上設備レベルは上げられません
		GOTO INPUT_LOOP
	ELSE
		PRINTL 
		PRINTFORML 設備のレベルアップには{10000 * FLAG:52 + 10000}＄必要です
		PRINTL 設備のレベルアップを行いますか？
		
		PRINTL [0]はい
		PRINTL [1]いいえ
		$INPUT_LOOP_SELECT_2
		INPUT
		IF RESULT == 0
			IF MONEY < 10000 * FLAG:52 + 10000
				PRINTL 所持資金が足りません
				PRINTW 
				GOTO INPUT_LOOP
			ELSE
				MONEY -= 10000 * FLAG:52 + 10000
				FLAG:52 += 1
				PRINTL 設備レベルが上がりました！
				PRINTW 
			ENDIF
		ELSEIF RESULT == 1
		ELSE
			PRINTL 
			PRINTL 正しい値を入力してください
			GOTO INPUT_LOOP_SELECT_2
		ENDIF
	ENDIF
GOTO INPUT_LOOP

ELSEIF RESULT == 3
	IF (FLAG:53 & 観葉植物) && (FLAG:53 & 心休まる風景画) && (FLAG:53 & オシャレなオブジェ) && (FLAG:53 & ゴージャスな噴水) && (FLAG:53 & 上質なベッド) && (FLAG:53 & 最高級ベッド) && (FLAG:53 & マッサージチェア) && (FLAG:53 & シャワー設備) && (FLAG:53 & ゲームコーナー) && (FLAG:53 & 大浴場) && (FLAG:53 & 美容温泉) && (FLAG:53 & ビューティサロン)
		PRINTL もう追加できるものがありません
		GOTO INPUT_LOOP
	ELSE
		CALL SHORTLINE
		PRINTFORML 　＊　カタログ　＊
		CALL SHORTLINE
		SIF (FLAG:53 & 観葉植物) == 0
			PRINTFORML [0]観葉植物　　　　　　   500＄　常に疲労度を微量回復
		SIF (FLAG:53 & 心休まる風景画) == 0 && (FLAG:53 & 観葉植物)
			PRINTFORML [0]心休まる風景画　　　  4500＄　常に疲労度を微量回復
		SIF (FLAG:53 & オシャレなオブジェ) == 0 && (FLAG:53 & 心休まる風景画)
			PRINTFORML [0]オシャレなオブジェ　  8500＄　常に疲労度を微量回復
		SIF (FLAG:53 & ゴージャスな噴水) == 0 && (FLAG:53 & オシャレなオブジェ)
			PRINTFORML [0]ゴージャスな噴水　　100000＄　常に疲労度を微量回復　 \@ (FLAG:30 > 0 && FLAG:854 > 0) == 1 ? 出費＋1000 #  \@
		SIF (FLAG:53 & 上質なベッド) == 0
			PRINTFORML [1]上質なベッド　　　　 12000＄　夜間休憩の疲労回復量がアップ　\@ (FLAG:30 > 0 && FLAG:854 > 0) == 1 ? 出費＋100 #  \@
		SIF (FLAG:53 & 最高級ベッド) == 0 && (FLAG:53 & 上質なベッド)
			PRINTFORML [1]最高級ベッド　　　　 95000＄　夜間休憩の疲労回復量が大アップ  \@ (FLAG:30 > 0 && FLAG:854 > 0) == 1 ? 出費＋400 #  \@
		SIF (FLAG:53 & マッサージチェア) == 0
			PRINTFORML [2]マッサージチェア　　 25800＄　常に疲労度を小回復  \@ (FLAG:30 > 0 && FLAG:854 > 0) == 1 ? 出費＋250 #  \@
		SIF (FLAG:53 & シャワー設備) == 0
			PRINTFORML [3]シャワー設備　　　　 50000＄　鍛錬後に疲労度を小回復  \@ (FLAG:30 > 0 && FLAG:854 > 0) == 1 ? 出費＋200 #  \@
		SIF (FLAG:53 & ゲームコーナー) == 0
			PRINTFORML [4]ゲームコーナー　　　100000＄　昼間休憩の疲労回復量がアップ  \@ (FLAG:30 > 0 && FLAG:854 > 0) == 1 ? 出費＋1000 #  \@
		SIF (FLAG:53 & 大浴場) == 0
			PRINTFORML [5]大浴場　　　　　　　200000＄　休憩時の疲労回復量がアップ  \@ (FLAG:30 > 0 && FLAG:854 > 0) == 1 ? 出費＋1000 #  \@
		SIF (FLAG:53 & 美容温泉) == 0 && (FLAG:53 & 大浴場)
			PRINTFORML [5]美容温泉　　　　　　500000＄　休憩時の疲労回復量が大アップ  \@ (FLAG:30 > 0 && FLAG:854 > 0) == 1 ? 出費＋5000 #  \@
		SIF (FLAG:53 & ビューティサロン) == 0
			PRINTFORML [6]ビューティサロン　 1500000＄　休憩時の疲労回復量が超アップ  \@ (FLAG:30 > 0 && FLAG:854 > 0) == 1 ? 出費＋10000 #  \@
		PRINTFORML [99]戻る
		$INPUT_LOOP_SELECT_3
		INPUT
		IF RESULT == 0 && (FLAG:53 & 観葉植物) == 0
			IF MONEY < 500
				PRINTL 所持資金が足りません
				PRINTW 
				GOTO INPUT_LOOP_SELECT_3
			ELSE
				MONEY -= 500
				FLAG:53 |= 観葉植物
				PRINTFORML 観葉植物を設置した！
				PRINTFORML （休憩していない時でも疲労度が僅かに回復します）
				PRINTW 
				GOTO INPUT_LOOP
			ENDIF
		ELSEIF RESULT == 0 && (FLAG:53 & 心休まる風景画) == 0 && (FLAG:53 & 観葉植物)
			IF MONEY < 4500
				PRINTL 所持資金が足りません
				PRINTW 
				GOTO INPUT_LOOP_SELECT_3
			ELSE
				MONEY -= 4500
				FLAG:53 |= 心休まる風景画
				PRINTFORML 心休まる風景画を設置した！
				PRINTFORML （休憩していない時でも疲労度が僅かに回復します）
				PRINTW 
				GOTO INPUT_LOOP
			ENDIF
		ELSEIF RESULT == 0 && (FLAG:53 & オシャレなオブジェ) == 0 && (FLAG:53 & 心休まる風景画)
			IF MONEY < 8500
				PRINTL 所持資金が足りません
				PRINTW 
				GOTO INPUT_LOOP_SELECT_3
			ELSE
				MONEY -= 8500
				FLAG:53 |= オシャレなオブジェ
				PRINTFORML オシャレなオブジェを設置した！
				PRINTFORML （休憩していない時でも疲労度が僅かに回復します）
				PRINTW 
				GOTO INPUT_LOOP
			ENDIF
		ELSEIF RESULT == 0 && (FLAG:53 & ゴージャスな噴水) == 0 && (FLAG:53 & オシャレなオブジェ)
			IF MONEY < 100000
				PRINTL 所持資金が足りません
				PRINTW 
				GOTO INPUT_LOOP_SELECT_3
			ELSE
				MONEY -= 100000
				FLAG:53 |= ゴージャスな噴水
				PRINTFORML ゴージャスな噴水を設置した！
				PRINTFORML （休憩していない時でも疲労度が僅かに回復します）
				PRINTW 
				GOTO INPUT_LOOP
			ENDIF
		ELSEIF RESULT == 1 && (FLAG:53 & 上質なベッド) == 0
			IF MONEY < 12000
				PRINTL 所持資金が足りません
				PRINTW 
				GOTO INPUT_LOOP_SELECT_3
			ELSE
				MONEY -= 12000
				FLAG:53 |= 上質なベッド
				PRINTFORML 上質なベッドを置いた！
				PRINTFORML （夜間の疲労度回復量がアップします）
				PRINTW 
				GOTO INPUT_LOOP
			ENDIF
		ELSEIF RESULT == 1 && (FLAG:53 & 最高級ベッド) == 0 && (FLAG:53 & 上質なベッド)
			IF MONEY < 95000
				PRINTL 所持資金が足りません
				PRINTW 
				GOTO INPUT_LOOP_SELECT_3
			ELSE
				MONEY -= 95000
				FLAG:53 |= 最高級ベッド
				PRINTFORML 上質なベッドを置いた！
				PRINTFORML （夜間の疲労度回復量が大きくアップします）
					PRINTW 
				GOTO INPUT_LOOP
			ENDIF
		ELSEIF RESULT == 2 && (FLAG:53 & マッサージチェア) == 0
			IF MONEY < 25800
				PRINTL 所持資金が足りません
				PRINTW 
				GOTO INPUT_LOOP_SELECT_3
			ELSE
				MONEY -= 25800
				FLAG:53 |= マッサージチェア
				PRINTFORML マッサージチェアを設置した！
				PRINTFORML （休憩していない時でも疲労度が少し回復します）
				PRINTW 
				GOTO INPUT_LOOP
			ENDIF
		ELSEIF RESULT == 3 && (FLAG:53 & シャワー設備) == 0
			IF MONEY < 50000
				PRINTL 所持資金が足りません
				PRINTW 
				GOTO INPUT_LOOP_SELECT_3
			ELSE
				MONEY -= 50000
				FLAG:53 |= シャワー設備
				PRINTFORML 入浴設備にシャワーを追加した！
				PRINTFORML （鍛錬後に疲労度が少し回復します）
				PRINTW 
				GOTO INPUT_LOOP
			ENDIF
		ELSEIF RESULT == 4 && (FLAG:53 & ゲームコーナー) == 0
			IF MONEY < 100000
				PRINTL 所持資金が足りません
				PRINTW 
				GOTO INPUT_LOOP_SELECT_3
			ELSE
				MONEY -= 100000
				FLAG:53 |= ゲームコーナー
				PRINTFORML ゲームコーナーを開設した！
				PRINTFORML （昼間の疲労度回復量が大きくアップします）
				PRINTW 
				GOTO INPUT_LOOP
			ENDIF
		ELSEIF RESULT == 5 && (FLAG:53 & 大浴場) == 0
			IF MONEY < 200000
				PRINTL 所持資金が足りません
				PRINTW 
				GOTO INPUT_LOOP_SELECT_3
			ELSE
				MONEY -= 200000
				FLAG:53 |= 大浴場
				PRINTFORML 入浴設備を広々とした大浴場に改修した！
				PRINTFORML （疲労度回復量がアップします）
				PRINTW 
				GOTO INPUT_LOOP
			ENDIF
		ELSEIF RESULT == 5 && (FLAG:53 & 美容温泉) == 0 && (FLAG:53 & 大浴場)
			IF MONEY < 500000
				PRINTL 所持資金が足りません
				PRINTW 
				GOTO INPUT_LOOP_SELECT_3
			ELSE
				MONEY -= 500000
				FLAG:53 |= 美容温泉
				PRINTFORML 美肌効果のある温泉を引いた！
				PRINTFORML （疲労度回復量がかなり回復します）
				PRINTW 
				GOTO INPUT_LOOP
			ENDIF
		ELSEIF RESULT == 6 && (FLAG:53 & ビューティサロン) == 0
			IF MONEY < 1500000
				PRINTL 所持資金が足りません
				PRINTW 
				GOTO INPUT_LOOP_SELECT_3
			ELSE
				MONEY -= 1500000
				FLAG:53 |= ビューティサロン
				PRINTFORML メンバー専用のビューティサロンを開設した！
				PRINTFORML （疲労度回復量がものすごくアップします）
				PRINTW 
				GOTO INPUT_LOOP
			ENDIF
		ELSEIF RESULT == 99
			GOTO INPUT_LOOP
		ELSE
			PRINTL 
			PRINTL 正しい値を入力してください
			GOTO INPUT_LOOP_SELECT_3
		ENDIF
	ENDIF
ELSEIF RESULT == 4 && FLAG:54 == 0 && MONEY >= 100000
MONEY -= 100000
PRINTFORML 芸能オフィスを設置した。
PRINTFORML （既にデビューしたメンバーの魅了経験が毎日自動アップするようになった）
PRINTW 
FLAG:54 = 1
GOTO INPUT_LOOP
ELSEIF RESULT == 4 && FLAG:54 == 0 && MONEY < 100000
PRINTFORML 所持資金が足りません
PRINTW
GOTO INPUT_LOOP
ELSEIF RESULT == 4 && FLAG:54 == 1
PRINTFORML 未実装です
GOTO INPUT_LOOP
ELSE
	PRINTL 
	PRINTL 正しい値を入力してください
	GOTO INPUT_LOOP
ENDIF

;--------------------------------------------------
;キャラ名を変更するキャラを選ぶ
@NAME_CHANGE_SELECT
CALL CHARA_LIST
IF RESULT == 999
ELSE
	CALL NAME_CHANGE, RESULT
ENDIF
PRINTL 

@AFTER_RESCUED,ARG
#DIM LCOUNT
LCOUNT = TARGET
TARGET = ARG

PRINTL 
PRINTFORML %CALLNAME%は治療を受けています・・・
CALL TRANSFORM, 0
;行動予定をリセット
CFLAG:ARG:100 = 0
;淫紋の進行度が低下
CALL TATTOO_ACCESS, "PROGRESS_VAR"
RESULT = RESULT * 7 / 10
IF RESULT == 0
	FLAG:32 = 0
ELSE
	CALL SAVE_TATTOO, RESULT
ENDIF
IF CHECK_PREGNANT_F(ARG) > 0
	PRINTFORML 妊娠していたため、大事を取って特別病棟に移りました・・・
	PRINTL 
	CFLAG:ARG:0 = 10
	CALL SET_PARTYMEMBER
ELSE
	PRINTFORML 幸い命に別条はないようです・・・
	PRINTL 
	CFLAG:ARG:0 = 0
	CALL RECOVER_TO_PARTY, ARG
ENDIF
TARGET = LCOUNT

;淫紋の進行/回復
@INMON_RECOVERY,ARG
#DIM LCOUNT
#DIM CCOUNT
LOCAL:2 = TARGET
TARGET = ARG
IF FILTER_CHECK_F(9)
	IF CFLAG:32 > 0 && CFLAG:0 == 0 && TALENT:触手の虜 == 1
		;汚染度が上昇する
		RESULT:1 = 2 + RAND:(LIMIT(SQRT(100 - CFLAG:32 / 10000000000000000),1,8)) + RAND:(MIN(ABL:欲望 + 1,5)) + RAND:(MIN(ABL:触手中毒 + 1,5))
		RESULT:1 = RESULT:1 * 3 / 4
		CALL TATTOO_ACCESS, "PROGRESS_VAR"
		CALL SAVE_TATTOO, LIMIT(RESULT + RESULT:1,0,100)
		PRINTFORML %CALLNAME%の淫紋が{RESULT:1}％進行した・・・（{CFLAG:32 / 10000000000000000}％）
		PRINTW 

		;悪堕ちする
		CALL TATTOO_ACCESS, "PROGRESS_VAR"
		IF RESULT >= 100 && FILTER_CHECK_F(10) == 0
			;生き残っているボスからランダムに１体を選択
			CALL CLEARRANDCHOOSE
			IF FLAG:10 == 0
				CALL GET_BOSS_ERB_NUM
			ELSE
				CALL GET_LASTBOSS_ERB_NUM
			ENDIF
			FOR LCOUNT, 0, RESULT
				;裏ボスを対象から除外
				SIF FLAG:10 != 0 && LCOUNT == 1 && FLAG:21 == 0
					CONTINUE
				CALL TENTACLE_BITVALUE, LCOUNT + 1
				CALL TENTACLE_SURVIVE_CHECK, RESULT
				SIF RESULT > 0
					CALL ADDRANDCHOOSE, RESULT
			NEXT
			CFLAG:20 = FLAG:10
			CFLAG:21 = RANDCHOOSE_F()

			;戦闘能力のあるキャラなら悪堕ち
			IF TALENT:変身能力 >= 0
				CFLAG:0 = 3
				;変身可能キャラならアウターが変更される
				SIF TALENT:変身能力 == 1
					CFLAG:41 = 401
				;陥落経験を加算
				EXP:陥落経験 += 1

				;地の文：悪堕ちになった
				CALL MESSAGE_SHOP_AKUOTI
				;ソロモードでキャラ全員が洗脳/悪堕ちになるとゲームオーバー
				LOCAL:1 = 0
				FOR CCOUNT,0,CHARANUM
					SIF CFLAG:CCOUNT:0 == 2 || CFLAG:CCOUNT:0 == 3
						LOCAL:1 ++
				NEXT
				IF FLAG:0 == 2 && (CHARANUM - LOCAL:1) < 2
					CALL ENDING_4
					DRAWLINE
				ENDIF
				PRINTFORML %STR:2500%の尖兵となった%CALLNAME%に邪悪な力が流れ込む・・・
				PRINTL 
				;悪堕ち時に大量の経験値が手に入る
				CALL TENTACLE_LEVEL
				IF CFLAG:0 == 2
					LOCAL = 20 * (5 + ABL:レベル) + RAND:25
				ELSEIF CFLAG:0 == 3
					LOCAL = 40 * (5 + ABL:レベル) + RAND:50
				ENDIF
				SIF LOCAL < 50
					LOCAL = 50
				CALL GET_EXP,min(LOCAL,750)
				;遭遇率アップ効果をリセット
				CFLAG:23 = 0
			;戦闘能力がなく、ＴＳできないオトコかつ男女平等オフなら即座に死亡
			ELSEIF CHARATALENT_F(TARGET,0,"オトコ") > 0 && TALENT:変身時ＴＳ < 1 && FILTER_CHECK_F(5) && CONFIG_CHECK_OTHER_F(1) == 0
				CFLAG:0 = 9

				;地の文：自分から幽閉される
				CALL MESSAGE_SHOP_PRISON
				PRINTW 
				;地の文:即死
				PRINTFORML オトコである%PRINT_TRANSCALLNAME(TARGET)%はそのままトドメを刺され、
				PRINTFORML %STR:2500%に取り込まれていってしまった・・・
				PRINTW 
				PRINTFORML %PRINT_TRANSCALLNAME(TARGET)%はロストしました
				PRINTW 

				;初めての幽閉なら異常経験を付ける
				SIF EXP:幽閉経験 == 0
					EXP:異常経験 += 1

					EXP:幽閉経験 += 1
				;遭遇率アップ効果をリセット
				CFLAG:23 = 0
			;戦闘能力のないキャラなら幽閉
			ELSE
				CFLAG:0 = 1

				;地の文：自分から幽閉される
				CALL MESSAGE_SHOP_PRISON

				;初めての幽閉なら異常経験を付ける
				SIF EXP:幽閉経験 == 0
				EXP:異常経験 += 1
				;幽閉経験を加算
				EXP:幽閉経験 += 1
				;遭遇率アップ効果をリセット
				CFLAG:23 = 0
			ENDIF
			PRINTW 
		ENDIF
		DRAWLINE
	ENDIF
;淫紋の回復
ELSE
	TARGET = ARG
	IF CFLAG:32 > 0
		CALL TATTOO_ACCESS, "PROGRESS_VAR"
		RESULT = RESULT * 9 / 10
		IF RESULT == 0
			CFLAG:32 = 0
		ELSE
			CALL SAVE_TATTOO, RESULT
		ENDIF
	ENDIF
ENDIF
TARGET = LOCAL:2

@SET_PARTYMEMBER
#DIM CCOUNT
;パーティキャラ自動管理
SIF CHARANUM < 3 && CHARANUM_ALIVE_PARTYCHECK(0) == 0
	FLAG:63 = 0
FOR CCOUNT, 0, CHARANUM
	SIF CCOUNT == MASTER
		CONTINUE
	IF CHECK_PREGNANT_F(CCOUNT) > 0 && CFLAG:CCOUNT:100 == 101 && CFLAG:CCOUNT:0 < 1
		PRINTFORML %CALLNAME:CCOUNT%は妊娠しているため出撃できなくなりました
		PRINTW 
		CFLAG:CCOUNT:100 = 103
	ELSEIF CHECK_PREGNANT_F(CCOUNT) > 0 && CFLAG:CCOUNT:100 == 105
		PRINTFORML %CALLNAME:CCOUNT%は妊娠しているため防衛できなくなりました
		PRINTW 
		CFLAG:CCOUNT:100 = 103
	ENDIF
	;離脱したキャラを最後尾に移動
	IF (CFLAG:CCOUNT:0 != 0) && CCOUNT < CHARANUM -1 && CFLAG:CCOUNT:999
		CFLAG:CCOUNT:999 = 0
		CALL SHIFTBACK_CHARA,CCOUNT
	ELSEIF CFLAG:CCOUNT:0 != 0 && CFLAG:CCOUNT:999
		CFLAG:CCOUNT:999 = 0
	ENDIF
NEXT


@SHIFTBACK_CHARA,ARG
;ARG番目のキャラをリストの最後尾に移動する
VARSET LOCAL
FOR LOCAL, ARG, CHARANUM -1
	SIF LOCAL == MASTER
		CONTINUE
	;RELATION
	FOR LOCAL:1, 0, CHARANUM
		SIF LOCAL:1 == MASTER
			CONTINUE
		SWAP RELATION:(LOCAL:1):LOCAL, RELATION:(LOCAL:1):(LOCAL + 1)
	NEXT
	SWAPCHARA LOCAL,LOCAL + 1
NEXT


@SHIFTFOWARD_CHARA,ARG
;ARG番目のキャラをパーティの最前部に移動する
VARSET LOCAL
FOR LOCAL, 0, CHARANUM
	SIF CFLAG:LOCAL:999
		LOCAL:1 = LOCAL
NEXT
FOR LOCAL, ARG, LOCAL:1, -1
	SIF LOCAL == MASTER
		CONTINUE
	;RELATION
	FOR LOCAL:1, 0, CHARANUM
		SIF LOCAL:1 == MASTER
			CONTINUE
		SWAP RELATION:(LOCAL:1):LOCAL, RELATION:(LOCAL:1):(LOCAL - 1)
	NEXT
	SWAPCHARA LOCAL,LOCAL - 1
NEXT



@RECOVER_TO_PARTY,ARG
;ARG番目のキャラをパーティに復帰させる
CFLAG:ARG:0 = 0
;パーティ人数が最大未満なら自動でパーティに加える
IF CHARANUM_ACTIVE() < パーティ人数最大値 && CFLAG:ARG:999 == 0
	CFLAG:ARG:999 = 1
	PRINTL 
	PRINTFORML %CALLNAME:ARG%がパーティメンバーに加わりました
	PRINTW 
ELSE
	PRINTL 
	PRINTFORML %CALLNAME:ARG%が控えメンバーに加わりました
	PRINTW 
ENDIF
IF CFLAG:ARG:6 == -1
	IF TALENT:ARG:固有キャラ
	   CFLAG:ARG:6 = NO:ARG
	ELSE
	   CFLAG:ARG:6 = 0
	ENDIF
ENDIF

@GET_DAILYFEE
#DIM FEE,2
FEE = 0
FEE:1 = 0
IF FLAG:30 > 0 && FLAG:854 > 0
	;施設維持費用UP
	FEE += 100 + 500 * POWER(FLAG:50,2) ;鍛錬設備
	FEE += 100 + 100 * POWER(FLAG:51,2) ;休憩設備
	FEE += 100 + 500 * POWER(FLAG:52,2) ;防衛設備

	SIF (FLAG:53 & ゴージャスな噴水)
	FEE:1 += 1000
	SIF (FLAG:53 & 上質なベッド)  && (FLAG:53 & 最高級ベッド) == 0
	FEE:1 += 500
	SIF (FLAG:53 & 最高級ベッド) 
	FEE:1 += 1000
	SIF (FLAG:53 & マッサージチェア) 
	FEE:1 += 250
	SIF (FLAG:53 & シャワー設備)
	FEE:1 += 200
	SIF (FLAG:53 & ゲームコーナー) 
	FEE:1 += 1000
	SIF (FLAG:53 & 大浴場) && (FLAG:53 & 美容温泉) == 0
	FEE:1 += 1000
	SIF (FLAG:53 & 美容温泉) && (FLAG:53 & 大浴場)
	FEE:1 += 5000
	SIF (FLAG:53 & ビューティサロン)
	FEE:1 += 10000	
ENDIF

維持費:1 = FEE
維持費:2 = FEE:1
維持費 = FEE + FEE:1


RETURN
