;出撃可能チェック
@SORTIE_CHECK
#DIM CCOUNT
LOCAL = 0
FOR CCOUNT, 0, CHARANUM
	SIF CCOUNT == MASTER
		CONTINUE
	SIF (CFLAG:CCOUNT:100 == 101 && BASE:CCOUNT:体力 > 500) || (CFLAG:CCOUNT:100 == 105 && BASE:CCOUNT:体力 > 500)
		LOCAL += 1
NEXT
RETURN LOCAL

;--------------------------------------------------
;キャラ名を変更するキャラを選ぶ
@NAME_CHANGE_SELECT
CALL CHARA_LIST
IF RESULT == 999
ELSE
	CALL NAME_CHANGE, RESULT
ENDIF
PRINTL 

@AFTER_RESCUED,ARG
#DIM LCOUNT
LCOUNT = TARGET
TARGET = ARG

PRINTL 
PRINTFORML %CALLNAME%は治療を受けています・・・
CALL TRANSFORM, 0
;行動予定をリセット
CFLAG:ARG:100 = 0
;淫紋の進行度が低下
CALL TATTOO_ACCESS, "PROGRESS_VAR"
RESULT = RESULT * 7 / 10
IF RESULT == 0
	FLAG:32 = 0
ELSE
	CALL SAVE_TATTOO, RESULT
ENDIF
IF CHECK_PREGNANT_F(ARG) > 0
	PRINTFORML 妊娠していたため、大事を取って特別病棟に移りました・・・
	PRINTL 
	CFLAG:ARG:0 = 10
	CALL SET_PARTYMEMBER
ELSE
	PRINTFORML 幸い命に別条はないようです・・・
	PRINTL 
	CFLAG:ARG:0 = 0
	CALL RECOVER_TO_PARTY, ARG
ENDIF
TARGET = LCOUNT

;淫紋の進行/回復
@INMON_RECOVERY,ARG
#DIM LCOUNT
#DIM CCOUNT
LOCAL:2 = TARGET
TARGET = ARG
IF FILTER_CHECK_F(9)
	IF CFLAG:32 > 0 && CFLAG:0 == 0 && TALENT:触手の虜 == 1
		;汚染度が上昇する
		RESULT:1 = 2 + RAND:(LIMIT(SQRT(100 - CFLAG:32 / 10000000000000000),1,8)) + RAND:(MIN(ABL:欲望 + 1,5)) + RAND:(MIN(ABL:触手中毒 + 1,5))
		RESULT:1 = RESULT:1 * 3 / 4
		CALL TATTOO_ACCESS, "PROGRESS_VAR"
		CALL SAVE_TATTOO, LIMIT(RESULT + RESULT:1,0,100)
		PRINTFORML %CALLNAME%の淫紋が{RESULT:1}％進行した・・・（{CFLAG:32 / 10000000000000000}％）
		PRINTW 

		;悪堕ちする
		CALL TATTOO_ACCESS, "PROGRESS_VAR"
		IF RESULT >= 100 && FILTER_CHECK_F(10) == 0
			;生き残っているボスからランダムに１体を選択
			CALL CLEARRANDCHOOSE
			IF FLAG:10 == 0
				CALL GET_BOSS_ERB_NUM
			ELSE
				CALL GET_LASTBOSS_ERB_NUM
			ENDIF
			FOR LCOUNT, 0, RESULT
				;裏ボスを対象から除外
				SIF FLAG:10 != 0 && LCOUNT == 1 && FLAG:21 == 0
					CONTINUE
				CALL TENTACLE_BITVALUE, LCOUNT + 1
				CALL TENTACLE_SURVIVE_CHECK, RESULT
				SIF RESULT > 0
					CALL ADDRANDCHOOSE, RESULT
			NEXT
			CFLAG:20 = FLAG:10
			CFLAG:21 = RANDCHOOSE_F()

			;戦闘能力のあるキャラなら悪堕ち
			IF TALENT:変身能力 >= 0
				CFLAG:0 = 3
				;変身可能キャラならアウターが変更される
				SIF TALENT:変身能力 == 1
					CFLAG:41 = 401
				;陥落経験を加算
				EXP:陥落経験 += 1

				;地の文：悪堕ちになった
				CALL MESSAGE_SHOP_AKUOTI
				;ソロモードでキャラ全員が洗脳/悪堕ちになるとゲームオーバー
				LOCAL:1 = 0
				FOR CCOUNT,0,CHARANUM
					SIF CFLAG:CCOUNT:0 == 2 || CFLAG:CCOUNT:0 == 3
						LOCAL:1 ++
				NEXT
				IF FLAG:0 == 2 && (CHARANUM - LOCAL:1) < 2
					CALL ENDING_4
					DRAWLINE
				ENDIF
				PRINTFORML %STR:2500%の尖兵となった%CALLNAME%に邪悪な力が流れ込む・・・
				PRINTL 
				;悪堕ち時に大量の経験値が手に入る
				CALL TENTACLE_LEVEL
				IF CFLAG:0 == 2
					LOCAL = 20 * (5 + ABL:レベル) + RAND:25
				ELSEIF CFLAG:0 == 3
					LOCAL = 40 * (5 + ABL:レベル) + RAND:50
				ENDIF
				SIF LOCAL < 50
					LOCAL = 50
				CALL GET_EXP,min(LOCAL,750)
				;遭遇率アップ効果をリセット
				CFLAG:23 = 0
			;戦闘能力がなく、ＴＳできないオトコかつ男女平等オフなら即座に死亡
			ELSEIF CHARATALENT_F(TARGET,0,"オトコ") > 0 && TALENT:変身時ＴＳ < 1 && FILTER_CHECK_F(5) && CONFIG_CHECK_OTHER_F(1) == 0
				CFLAG:0 = 9

				;地の文：自分から幽閉される
				CALL MESSAGE_SHOP_PRISON
				PRINTW 
				;地の文:即死
				PRINTFORML オトコである%PRINT_TRANSCALLNAME(TARGET)%はそのままトドメを刺され、
				PRINTFORML %STR:2500%に取り込まれていってしまった・・・
				PRINTW 
				PRINTFORML %PRINT_TRANSCALLNAME(TARGET)%はロストしました
				PRINTW 

				;初めての幽閉なら異常経験を付ける
				SIF EXP:幽閉経験 == 0
					EXP:異常経験 += 1

					EXP:幽閉経験 += 1
				;遭遇率アップ効果をリセット
				CFLAG:23 = 0
			;戦闘能力のないキャラなら幽閉
			ELSE
				CFLAG:0 = 1

				;地の文：自分から幽閉される
				CALL MESSAGE_SHOP_PRISON

				;初めての幽閉なら異常経験を付ける
				SIF EXP:幽閉経験 == 0
				EXP:異常経験 += 1
				;幽閉経験を加算
				EXP:幽閉経験 += 1
				;遭遇率アップ効果をリセット
				CFLAG:23 = 0
			ENDIF
			PRINTW 
		ENDIF
		DRAWLINE
	ENDIF
;淫紋の回復
ELSE
	TARGET = ARG
	IF CFLAG:32 > 0
		CALL TATTOO_ACCESS, "PROGRESS_VAR"
		RESULT = RESULT * 9 / 10
		IF RESULT == 0
			CFLAG:32 = 0
		ELSE
			CALL SAVE_TATTOO, RESULT
		ENDIF
	ENDIF
ENDIF
TARGET = LOCAL:2

@SET_PARTYMEMBER
#DIM CCOUNT
;パーティキャラ自動管理
SIF CHARANUM < 3 && CHARANUM_ALIVE_PARTYCHECK(0) == 0
	FLAG:63 = 0
FOR CCOUNT, 0, CHARANUM
	SIF CCOUNT == MASTER
		CONTINUE
	IF CHECK_PREGNANT_F(CCOUNT) > 0 && CFLAG:CCOUNT:100 == 101 && CFLAG:CCOUNT:0 < 1
		PRINTFORML %CALLNAME:CCOUNT%は妊娠しているため出撃できなくなりました
		PRINTW 
		CFLAG:CCOUNT:100 = 103
	ELSEIF CHECK_PREGNANT_F(CCOUNT) > 0 && CFLAG:CCOUNT:100 == 105
		PRINTFORML %CALLNAME:CCOUNT%は妊娠しているため防衛できなくなりました
		PRINTW 
		CFLAG:CCOUNT:100 = 103
	ENDIF
	;離脱したキャラを最後尾に移動
	IF (CFLAG:CCOUNT:0 != 0) && CCOUNT < CHARANUM -1 && CFLAG:CCOUNT:999
		CFLAG:CCOUNT:999 = 0
		CALL SHIFTBACK_CHARA,CCOUNT
	ELSEIF CFLAG:CCOUNT:0 != 0 && CFLAG:CCOUNT:999
		CFLAG:CCOUNT:999 = 0
	ENDIF
NEXT


@SHIFTBACK_CHARA,ARG
;ARG番目のキャラをリストの最後尾に移動する
VARSET LOCAL
FOR LOCAL, ARG, CHARANUM -1
	SIF LOCAL == MASTER
		CONTINUE
	;RELATION
	FOR LOCAL:1, 0, CHARANUM
		SIF LOCAL:1 == MASTER
			CONTINUE
		SWAP RELATION:(LOCAL:1):LOCAL, RELATION:(LOCAL:1):(LOCAL + 1)
	NEXT
	SWAPCHARA LOCAL,LOCAL + 1
NEXT


@SHIFTFOWARD_CHARA,ARG
;ARG番目のキャラをパーティの最前部に移動する
VARSET LOCAL
FOR LOCAL, 0, CHARANUM
	SIF CFLAG:LOCAL:999
		LOCAL:1 = LOCAL
NEXT
FOR LOCAL, ARG, LOCAL:1, -1
	SIF LOCAL == MASTER
		CONTINUE
	;RELATION
	FOR LOCAL:1, 0, CHARANUM
		SIF LOCAL:1 == MASTER
			CONTINUE
		SWAP RELATION:(LOCAL:1):LOCAL, RELATION:(LOCAL:1):(LOCAL - 1)
	NEXT
	SWAPCHARA LOCAL,LOCAL - 1
NEXT



@RECOVER_TO_PARTY,ARG
;ARG番目のキャラをパーティに復帰させる
CFLAG:ARG:0 = 0
;パーティ人数が最大未満なら自動でパーティに加える
IF CHARANUM_ACTIVE() < パーティ人数最大値 && CFLAG:ARG:999 == 0
	CFLAG:ARG:999 = 1
	PRINTL 
	PRINTFORML %CALLNAME:ARG%がパーティメンバーに加わりました
	PRINTW 
ELSE
	PRINTL 
	PRINTFORML %CALLNAME:ARG%が控えメンバーに加わりました
	PRINTW 
ENDIF
IF CFLAG:ARG:6 == -1
	IF TALENT:ARG:固有キャラ
	   CFLAG:ARG:6 = NO:ARG
	ELSE
	   CFLAG:ARG:6 = 0
	ENDIF
ENDIF

@GET_DAILYFEE
#DIM FEE,2
FEE = 0
FEE:1 = 0
IF FLAG:30 > 0 && FLAG:854 > 0
	;施設維持費用UP
	FEE += 100 + 500 * POWER(FLAG:50,2) ;鍛錬設備
	FEE += 100 + 100 * POWER(FLAG:51,2) ;休憩設備
	FEE += 100 + 500 * POWER(FLAG:52,2) ;防衛設備

	SIF (FLAG:53 & ゴージャスな噴水)
	FEE:1 += 1000
	SIF (FLAG:53 & 上質なベッド)  && (FLAG:53 & 最高級ベッド) == 0
	FEE:1 += 500
	SIF (FLAG:53 & 最高級ベッド) 
	FEE:1 += 1000
	SIF (FLAG:53 & マッサージチェア) 
	FEE:1 += 250
	SIF (FLAG:53 & シャワー設備)
	FEE:1 += 200
	SIF (FLAG:53 & ゲームコーナー) 
	FEE:1 += 1000
	SIF (FLAG:53 & 大浴場) && (FLAG:53 & 美容温泉) == 0
	FEE:1 += 1000
	SIF (FLAG:53 & 美容温泉) && (FLAG:53 & 大浴場)
	FEE:1 += 5000
	SIF (FLAG:53 & ビューティサロン)
	FEE:1 += 10000	
ENDIF

MAINTECOST:1 = FEE
MAINTECOST:2 = FEE:1
MAINTECOST = FEE + FEE:1


RETURN
