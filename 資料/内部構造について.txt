

このテキストでは、改造しようと思っているけれど手の付け方が分からない方向けに
eraGVTの内部構造について大まかに説明します。
改造する際に留意するべき点についても記載しておくので、内部処理に詳しくない方は目を通しておくと良いでしょう。


　キャラメイクの処理

　　ゲームを開始するとキャラメイクをするかどうか聞かれますが、
　　キャラメイクを行う場合はFIRSTSETTING_CHARA.ERBが呼び出されます。

　　キャラメイクを終えた後はCHARA_MAKE_DEFAULT.ERBが呼び出され、
　　具体的に指定せず「ランダム」に設定されている項目や、キャラメイクを行わなかったキャラが居る場合は
　　埋める必要のある項目をすべて自動で埋めていきます。
　
　　キャラメイクを行わない選択をした場合も同様にCHARA_MAKE_DEFAULT.ERBが呼び出され、
　　ランダムでキャラデータが生成されるようになっています。



　メインメニュー(SHOP)の処理

　　キャラクターの行動を選択する場面では、いわゆるeramakerのSHOP画面が利用されています。
　　0~99の数字入力によるアイテム購入機能は無効化されており、代わりにキャラクター選択処理などに使われています。
　　プレイヤーが「行動開始」を選択するとループ処理に突入し、キャラクター全員が行動を終えるまでループを続けます。

　　このとき、処理はキャラ番号の若い順から行われ、未行動のキャラがいなくなるか、
　　DIM.ERHで設定されている「パーティ最大人数」まで達するとループを終了します。
　　キャラクターの行動はSHOP_ACTION.ERBで処理されています。

　　ループが完了すると@TURNENDの処理に進み、次のターンが開始されて再びSHOPの冒頭に戻ってきます。
　　このとき、FLAG:45のボス襲撃フラグが立っている場合は、$AFTER_RAIDラベルまでGOTOでスキップします。
　　これは戦闘処理の後は自動でターン終了時の処理が行われる仕様があるためで、
　　スキップしないと余分に１ターン経過してしまうからです。



　戦闘中の処理

　　GVTの戦闘処理ではeramakerの基本的な要素であるTRAINの構造がそのまま利用されています。
　　そのため、eramakerやその流れをくむバリアントを改造したことがある人は、その知識をそのまま応用できます。
　　戦闘に入るとTRAIN.ERBの@EVENTTRAINが呼び出され、次にステータス表示、@COMABLEを経てからのコマンドの表示、USERCOMの表示が行われます。
　　プレイヤーがコマンドを入力すると@COMが実行され、SOURCE.ERBの処理に入り、次のターンが開始されるわけですが、
　　SOURCE.ERBの処理中にボス触手による行動の処理が呼び出され、実行されます。

　　プレイヤーが選択する「攻撃」などのコマンドは他のバリアントにおける調教コマンドに相当し、
　　ボス触手による反撃は他のバリアントにおけるカウンター行動などと同じ構造になっています。

　　SOURCE.ERB内部で戦闘終了条件を満たしている場合はAFTERTRAINが呼ばれ、経験値獲得などの戦闘終了後の処理が行われます。

　　戦闘中の処理における注意点として、戦闘ではボスとTARGETの一騎打ちを前提としているため、
　　TALENTやCFLAGなどのキャラクター変数は対象を省略してTARGETのものを呼び出しています。
　　そのため、戦闘中にTARGETを変更するような処理は想定されていません。



　幽閉時の処理

　　幽閉の処理はSHOPにおけるターン終了時イベントとして呼び出されます。
　　幽閉されているキャラが存在すると処理が開始され、自動で処理内容が決定され、自動でJUELの増加やパラメータの成長が行われます。
　　このとき実行される幽閉時コマンドは戦闘時のボスの性コマンドと異なり、PALAMを経由せずに直接JUELを獲得するようになっています。
　　幽閉時にPALAMの上昇だと思ってソースの値を20000などに設定してしまうと、20000のJUELを獲得してしまうので注意が必要です。

　　この仕様は一度の幽閉に一回しか幽閉コマンドが実行されないため、JUELの上昇量が戦闘時とは異なり流動性が無いためです。
　　例えば戦闘中ではＶ攻め強を２回受けた時と３回受けた時では快ＶのJUEL増加量が変化しますが、
　　幽閉時でＶ攻めを受けた場合は１回で固定のため、JUELの獲得量は変化しません。

　　戦闘時と幽閉時で２通りの処理があって分かりにくいですが、この仕様には幽閉時のJUEL獲得量を調整しやすいという利点があるため、
　　元バリアントで設計された処理をそのまま使っています。




